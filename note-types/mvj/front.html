<div class="card-inner">
<div class="front">
    <div class="audio-row">
        {{#Word Audio}}
        <div class="audio-item fi" data-audio="word" style="--d:0">
            {{Word Audio}}
            <span class="audio-label">Word</span>
        </div>
        {{/Word Audio}}
        {{#Sentence Audio}}
        <div class="audio-item fi" data-audio="sentence" style="--d:70">
            {{Sentence Audio}}
            <span class="audio-label">Sentence</span>
        </div>
        {{/Sentence Audio}}
    </div>
    {{#Word}}
    <div id="raw-word" style="display:none">{{Word}}</div>
    {{/Word}}
    {{#Sentence}}
    <div id="raw-sentence" style="display:none">{{Sentence}}</div>
    {{/Sentence}}
    {{#Image}}
    <div id="raw-image" style="display:none">{{Image}}</div>
    {{/Image}}
    <div class="front-content">
        <h1 class="target-word" id="front-word"></h1>
        <p class="sentence" id="front-sentence"></p>
        <div class="image-wrap" id="front-image"></div>
    </div>
</div>

<div id="raw-tags" style="display:none">{{Tags}}</div>
<div id="raw-deck" style="display:none">{{Deck}}</div>

<script>
// Mode system — apply tag/deck-based settings overrides
(function() {
    var tagsEl = document.getElementById('raw-tags');
    var tags = tagsEl ? tagsEl.textContent.trim().split(/\s+/).filter(Boolean) : [];

    var deckEl = document.getElementById('raw-deck');
    var deck = deckEl ? deckEl.textContent.trim() : '';

    var root = document.documentElement;
    var rs = getComputedStyle(root);
    var settings = [
        'tategaki', 'color-scheme', 'debug', 'audio-labels', 'audio-buttons', 'card-transparency',
        'word-text', 'word-audio', 'word-furigana', 'word-pitch-color', 'pitch-graph',
        'sentence-text', 'sentence-audio', 'sentence-furigana', 'sentence-pitch-color',
        'image',
        'definition-text', 'definition-audio', 'definition-mode', 'definition-default', 'definition-furigana', 'definition-pitch-color'
    ];

    // Find last defined mode
    var lastMode = 0;
    for (var i = 1; i <= 20; i++) {
        if (!rs.getPropertyValue('--mode-' + i + '-tag').trim()
            && !rs.getPropertyValue('--mode-' + i + '-deck').trim()) break;
        lastMode = i;
    }

    function applyMode(n) {
        for (var j = 0; j < settings.length; j++) {
            var val = rs.getPropertyValue('--mode-' + n + '-' + settings[j]).trim();
            if (val) root.style.setProperty('--' + settings[j], val);
        }
    }

    // Deck matches: high→low so lower numbers take precedence
    for (var i = lastMode; i >= 1; i--) {
        var modeDeck = rs.getPropertyValue('--mode-' + i + '-deck').trim();
        if (!modeDeck) continue;
        var decks = modeDeck.split(',');
        var matched = false;
        for (var k = 0; k < decks.length; k++) {
            var d = decks[k].trim();
            if (d && (deck === d || deck.indexOf(d + '::') === 0)) { matched = true; break; }
        }
        if (matched) applyMode(i);
    }

    // Tag matches: high→low so lower numbers take precedence; tags beat decks
    for (var i = lastMode; i >= 1; i--) {
        var modeTag = rs.getPropertyValue('--mode-' + i + '-tag').trim();
        if (modeTag && tags.indexOf(modeTag) !== -1) applyMode(i);
    }
})();
</script>

<script>
// Tategaki mode — read CSS variable and add class before any rendering
(function() {
    var v = getComputedStyle(document.documentElement).getPropertyValue('--tategaki');
    if (v && v.trim() === 'on') document.documentElement.classList.add('tategaki');
    else if (v) document.documentElement.classList.remove('tategaki');
})();

// Color scheme — read CSS variable and set data attribute
(function() {
    var v = getComputedStyle(document.documentElement).getPropertyValue('--color-scheme');
    if (v) document.documentElement.setAttribute('data-color-scheme', v.trim() || 'blue');
})();

// Debug mode — read CSS variable and set data attribute
(function() {
    var v = getComputedStyle(document.documentElement).getPropertyValue('--debug');
    if (v) document.documentElement.setAttribute('data-debug', v.trim() || 'off');
})();

// Audio labels — read CSS variable and set data attribute
(function() {
    var v = getComputedStyle(document.documentElement).getPropertyValue('--audio-labels');
    if (v) document.documentElement.setAttribute('data-audio-labels', v.trim() || 'on');
})();

// Audio buttons — read CSS variable and set data attribute
(function() {
    var v = getComputedStyle(document.documentElement).getPropertyValue('--audio-buttons');
    if (v) document.documentElement.setAttribute('data-audio-buttons', v.trim() || 'on');
})();

// Card transparency — read CSS variable and set data attribute
(function() {
    var v = getComputedStyle(document.documentElement).getPropertyValue('--card-transparency');
    if (v) document.documentElement.setAttribute('data-card-transparency', v.trim() || 'on');
})();

// Route Web Audio through media channel (audible even with mute switch)
if (navigator.audioSession) navigator.audioSession.type = 'playback';

// Create AudioContext eagerly — Anki's WKWebView sets
// mediaTypesRequiringUserActionForPlayback=[] which allows
// AudioContext to reach 'running' without a gesture.
if (!window.__audioCtx) {
    window.__audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
if (window.__audioCtx.state === 'suspended') {
    window.__audioCtx.resume()['catch'](function() {});
}

// Safety net: if AudioContext is still suspended after page load,
// resume it on the next user gesture.
if (!window.__audioCtxTouchHandler) {
    window.__audioCtxTouchHandler = function() {
        if (window.__audioCtx && window.__audioCtx.state !== 'running') {
            window.__audioCtx.resume()['catch'](function() {});
        }
    };
    document.addEventListener('touchend', window.__audioCtxTouchHandler, { capture: true });
}

// Resume AudioContext after iOS app background/foreground switch.
// iOS suspends the WebView's audio session when backgrounded;
// the context moves to 'suspended' or the non-standard 'interrupted'
// state and does not auto-resume.
if (!window.__audioCtxVisHandler) {
    window.__audioCtxVisHandler = function() {
        if (document.visibilityState !== 'visible' || !window.__audioCtx) return;
        if (window.__audioCtx.state !== 'running') {
            window.__audioCtx.resume()['catch'](function() {});
        } else {
            // Context may claim 'running' while stalled (WebKit bug #263627).
            var t = window.__audioCtx.currentTime;
            setTimeout(function() {
                if (window.__audioCtx && window.__audioCtx.state === 'running'
                    && window.__audioCtx.currentTime === t) {
                    window.__audioCtx.suspend().then(function() {
                        return window.__audioCtx.resume();
                    })['catch'](function() {});
                }
            }, 200);
        }
    };
    document.addEventListener('visibilitychange', window.__audioCtxVisHandler);
}

(function() {
    if (!window.matchMedia('(hover: none)').matches) return;
    var ci = document.querySelector('.card-inner');
    if (!ci) return;
    var isBack = !!document.querySelector('.back');
    var fr = !isBack && document.querySelector('.front');
    var isTablet = window.innerWidth >= 768;
    var biVal = getComputedStyle(document.documentElement).getPropertyValue('--bottom-inset');
    var isTategaki = document.documentElement.classList.contains('tategaki');
    function lock() {
        var h = window.innerHeight;
        var rawBi = parseInt(biVal) || 0;
        var bi = Math.max(rawBi - 35, 0);
        if (isTategaki) {
            if (isBack) {
                document.body.style.height = (h - bi) + 'px';
                var tateInset = Math.max(40, rawBi + (isTablet ? 20 : 7));
                ci.style.height = Math.min(h - tateInset, isTablet ? 668 : Infinity) + 'px';
            }
        } else {
            if (isBack) {
                if (isTablet) {
                    document.body.style.height = (h - bi) + 'px';
                    ci.style.minHeight = '650px';
                } else {
                    document.body.style.height = (h - bi) + 'px';
                    ci.style.minHeight = (h - 40 - bi + 1) + 'px';
                }
            }
            if (fr && !fr.querySelector('.front-content [data-side="front"]')) {
                fr.style.paddingTop = isTablet ? '354px' : Math.round((h - bi - 120) * 0.52) + 'px';
            }
        }
    }
    if (window.innerHeight > 100) {
        lock();
    } else {
        (function wait() {
            requestAnimationFrame(function() {
                if (window.innerHeight > 100) { lock(); }
                else wait();
            });
        })();
    }
})();

// Clean up previous card
if (window.__stopAllAudio) window.__stopAllAudio();
document.querySelectorAll('body > audio').forEach(function(a) {
    a.pause();
    a.removeAttribute('src');
    a.load();
    a.remove();
});
if (window.__observers) {
    for (var i = 0; i < window.__observers.length; i++) window.__observers[i].disconnect();
}
window.__observers = [];

// Shared audio utilities (available on back via {{FrontSide}})
window.__audioSVG = '<svg viewBox="0 0 64 64"><circle cx="32" cy="32" r="29" fill="none" stroke="black" stroke-width="1"/><path d="M56.6,32l-36.5,21.1V10.9L56.6,32z"/></svg>';

window.__animateBtn = function(btn) {
    var isTouch = window.matchMedia('(hover: none)').matches;
    if (isTouch) {
        btn.classList.add('highlight-touch');
        setTimeout(function() { btn.classList.remove('highlight-touch'); }, 350);
        return;
    }
    btn.style.transform = 'scale(0.95)';
    btn.style.transitionDuration = '80ms';
    btn.classList.add('highlight');
    setTimeout(function() { btn.style.transform = 'scale(1.06)'; btn.style.transitionDuration = ''; }, 100);
    setTimeout(function() {
        btn.style.transform = '';
        btn.classList.remove('highlight');
    }, 350);
};

window.__onTap = function(btn, handler, dblHandler) {
    btn._hasHandler = true;
    btn._tapHandler = handler;
    btn._dblHandler = dblHandler || null;
    if (btn._onTapBound) return;
    btn._onTapBound = true;
    var moved;
    var DBL_MS = 350;
    function dispatch(ev) {
        var now = Date.now();
        if (btn._dblHandler && btn._lastDispatch && now - btn._lastDispatch < DBL_MS) {
            btn._lastDispatch = 0;
            btn._dblHandler(ev);
        } else {
            btn._lastDispatch = now;
            btn._tapHandler(ev);
        }
    }
    btn.addEventListener('touchstart', function() { moved = false; }, { passive: true });
    btn.addEventListener('touchmove', function() { moved = true; }, { passive: true });
    btn.addEventListener('touchend', function(ev) {
        if (moved) return;
        ev.preventDefault();
        btn._lastTapTime = Date.now();
        dispatch(ev);
    });
    btn.addEventListener('click', function(ev) {
        ev.preventDefault();
        if (btn._lastTapTime && Date.now() - btn._lastTapTime < 400) return;
        dispatch(ev);
    });
};

window.__clickSoundLink = function(html) {
    var tmp = document.createElement('div');
    tmp.innerHTML = html;
    var link = tmp.firstElementChild;
    if (link) {
        link.style.position = 'fixed';
        link.style.opacity = '0';
        link.style.pointerEvents = 'none';
        document.body.appendChild(link);
        link.click();
        setTimeout(function() { if (link.parentNode) link.remove(); }, 200);
    }
};

window.__extractAudio = function(container) {
    var filenames = [];
    var usePycmd = false;
    var text = container.textContent;
    var re = /\[audio:([^\]]+)\]/g;
    var m;
    while ((m = re.exec(text)) !== null) filenames.push(m[1].replace(/#/g, '%23').replace(/\?/g, '%3F'));
    if (!filenames.length) {
        container.querySelectorAll('.soundLink').forEach(function(link) {
            filenames.push(link.outerHTML);
        });
        if (filenames.length) usePycmd = true;
    }
    if (!filenames.length) {
        container.querySelectorAll('audio').forEach(function(a) {
            var src = a.getAttribute('src') || (a.querySelector('source') || {}).getAttribute && (a.querySelector('source') || {}).getAttribute('src');
            if (src) filenames.push(src);
        });
    }
    return { filenames: filenames, usePycmd: usePycmd };
};

window.__adoptNativeAudio = function(elements) {
    var SVG = window.__audioSVG;
    var buttons = [];
    for (var i = 0; i < elements.length; i++) {
        var el = elements[i];
        if (el.classList && el.classList.contains('replay-button')) {
            buttons.push(el);
        } else if (el.tagName === 'AUDIO') {
            el.style.display = 'none';
            el.removeAttribute('controls');
            document.body.appendChild(el);
            var btn = document.createElement('a');
            btn.className = 'replay-button soundLink';
            btn.href = '#';
            btn.innerHTML = SVG;
            if (window.__defAudioEls) window.__defAudioEls.push(el);
            (function(audio, b) {
                window.__onTap(b, function() {
                    if (window.matchMedia('(hover: none)').matches) {
                        window.__stopAllAudio();
                        window.__animateBtn(b);
                        window.__playMobile(audio.src, b);
                    } else {
                        window.__stopAllAudio(audio);
                        audio.currentTime = 0;
                        window.__safePlay(audio);
                        window.__animateBtn(b);
                        window.__startPlaying(audio, b);
                    }
                }, function() { window.__stopAllAudio(); });
            })(el, btn);
            buttons.push(btn);
        }
    }
    return buttons;
};

window.__stopAllAudio = function(except) {
    window.__webAudioGen = (window.__webAudioGen || 0) + 1;
    if (window.__webAudioSource) {
        try { window.__webAudioSource.stop(); } catch(e) {}
        window.__webAudioSource = null;
    }
    window.__autoPlayDefAudio = null;
    document.querySelectorAll('.replay-button.playing').forEach(function(b) {
        b.classList.remove('playing');
    });
    document.querySelectorAll('.text-play.playing').forEach(function(t) {
        t.classList.remove('playing');
    });
    var els = window.__defAudioEls || [];
    for (var i = 0; i < els.length; i++) {
        if (els[i] !== except) { els[i].pause(); els[i].currentTime = 0; }
        els[i].onended = null;
    }
    document.querySelectorAll('audio').forEach(function(a) {
        if (a !== except) { a.pause(); a.currentTime = 0; }
        a.onended = null;
    });
};

window.__safePlay = function(audio) {
    var p = audio.play();
    if (p && p['catch']) p['catch'](function(e) {
        if (e && (e.name === 'NotAllowedError' || e.name === 'AbortError')) return;
        if (audio.readyState < 3) {
            audio.load();
            audio.addEventListener('canplaythrough', function retry() {
                audio.removeEventListener('canplaythrough', retry);
                audio.play()['catch'](function() {});
            });
        } else {
            setTimeout(function() { audio.play()['catch'](function() {}); }, 50);
        }
    });
};

window.__startPlaying = function(audio, btn) {
    if (!btn) return;
    btn.classList.add('playing');
    btn._currentAudio = audio;

    var audioItem = btn.closest('.audio-item');
    var textKey = null;
    if (audioItem) {
        var audioType = audioItem.getAttribute('data-audio');
        var defLang = audioItem.getAttribute('data-def-lang');
        if (audioType === 'def' && defLang) textKey = 'def-' + defLang;
        else if (audioType) textKey = audioType;
    }
    var linkedTexts = textKey ? document.querySelectorAll('.text-play[data-text-play="' + textKey + '"]') : [];
    for (var ti = 0; ti < linkedTexts.length; ti++) linkedTexts[ti].classList.add('playing');

    function done() {
        if (btn._currentAudio === audio) btn.classList.remove('playing');
        for (var ti = 0; ti < linkedTexts.length; ti++) linkedTexts[ti].classList.remove('playing');
        audio.removeEventListener('ended', done);
        audio.removeEventListener('pause', done);
    }
    audio.addEventListener('ended', done);
    audio.addEventListener('pause', done);
    setTimeout(function() {
        if (btn._currentAudio === audio && audio.paused) {
            btn.classList.remove('playing');
            for (var ti = 0; ti < linkedTexts.length; ti++) linkedTexts[ti].classList.remove('playing');
        }
    }, 1000);
};

window.__freshPlay = function(src, btn) {
    if (btn && btn._freshAudio) {
        btn._freshAudio.pause();
        btn._freshAudio.removeAttribute('src');
        btn._freshAudio.load();
        if (btn._freshAudio.parentNode) btn._freshAudio.remove();
        btn._freshAudio = null;
    }
    var a = new Audio(src);
    a.style.display = 'none';
    document.body.appendChild(a);
    if (btn) btn._freshAudio = a;
    a.play()['catch'](function() {});
    return a;
};

window.__stopDefAudio = window.__stopAllAudio;

window.__linkTextPlay = function(textEl, audioKey, opts) {
    if (!textEl || (!opts.getAudioSrc && !opts.play)) return;

    textEl.classList.add('text-play');
    textEl.setAttribute('data-text-play', audioKey);

    window.__onTap(textEl, function() {
        if (opts.play) {
            opts.play();
            return;
        }
        var src = opts.getAudioSrc();
        if (!src) return;
        window.__stopAllAudio();
        var btn = opts.getBtn ? opts.getBtn() : null;
        if (btn) window.__animateBtn(btn);

        textEl.classList.add('playing');
        var allBtns = opts.getAllBtns ? opts.getAllBtns() : [];
        for (var i = 0; i < allBtns.length; i++) {
            allBtns[i].classList.add('playing');
        }

        var gen = window.__webAudioGen;
        window.__playMobile(src, null).then(function() {
            if (gen === window.__webAudioGen) {
                textEl.classList.remove('playing');
                for (var i = 0; i < allBtns.length; i++) {
                    allBtns[i].classList.remove('playing');
                }
            }
        })['catch'](function() {
            textEl.classList.remove('playing');
        });
    }, function() {
        window.__stopAllAudio();
    });

    if (window.matchMedia('(hover: hover)').matches) {
        textEl.addEventListener('mouseenter', function() {
            var allBtns = opts.getAllBtns ? opts.getAllBtns() : [];
            for (var i = 0; i < allBtns.length; i++) {
                allBtns[i].classList.add('hover-linked');
            }
        });
        textEl.addEventListener('mouseleave', function() {
            var allBtns = opts.getAllBtns ? opts.getAllBtns() : [];
            for (var i = 0; i < allBtns.length; i++) {
                allBtns[i].classList.remove('hover-linked');
            }
        });
    }
};

window.__linkBtnHoverToText = function(btn, audioKey) {
    if (!window.matchMedia('(hover: hover)').matches) return;
    var textEls = document.querySelectorAll('.text-play[data-text-play="' + audioKey + '"]');
    if (!textEls.length) return;
    btn.addEventListener('mouseenter', function() {
        for (var ti = 0; ti < textEls.length; ti++) textEls[ti].classList.add('hover-linked');
    });
    btn.addEventListener('mouseleave', function() {
        for (var ti = 0; ti < textEls.length; ti++) textEls[ti].classList.remove('hover-linked');
    });
};

window.__checkImageFit = function() {
    var THRESHOLD = 16 / 9;
    document.querySelectorAll('.image-wrap img').forEach(function(img) {
        function check() {
            if (!img.naturalWidth || !img.naturalHeight) return;
            var wrap = img.closest('.image-wrap');
            if (!wrap) return;
            wrap.classList.toggle('image-full', img.naturalWidth / img.naturalHeight < THRESHOLD);
        }
        if (img.complete && img.naturalWidth) check();
        else img.addEventListener('load', check);
    });
};

window.__webAudioPlay = function(src, btn, gen) {
    return fetch(src)
        .then(function(r) { return r.arrayBuffer(); })
        .then(function(buf) { return window.__audioCtx.decodeAudioData(buf); })
        .then(function(audioBuf) {
            if (gen !== undefined && gen !== window.__webAudioGen) return;
            return new Promise(function(resolve) {
                var source = window.__audioCtx.createBufferSource();
                source.buffer = audioBuf;
                source.connect(window.__audioCtx.destination);
                source.start();
                window.__webAudioSource = source;

                var linkedTexts = [];
                if (btn) {
                    btn.classList.add('playing');
                    btn._currentAudio = source;
                    var audioItem = btn.closest('.audio-item');
                    if (audioItem) {
                        var audioType = audioItem.getAttribute('data-audio');
                        var defLang = audioItem.getAttribute('data-def-lang');
                        var textKey = (audioType === 'def' && defLang) ? 'def-' + defLang : audioType;
                        if (textKey) linkedTexts = document.querySelectorAll('.text-play[data-text-play="' + textKey + '"]');
                    }
                    for (var ti = 0; ti < linkedTexts.length; ti++) linkedTexts[ti].classList.add('playing');
                }

                source.onended = function() {
                    if (window.__webAudioSource === source) window.__webAudioSource = null;
                    if (btn && btn._currentAudio === source) btn.classList.remove('playing');
                    for (var ti = 0; ti < linkedTexts.length; ti++) linkedTexts[ti].classList.remove('playing');
                    resolve();
                };
            });
        });
};

window.__playMobile = function(src, btn) {
    if (window.__audioCtx && window.__audioCtx.state === 'running') {
        return window.__webAudioPlay(src, btn, window.__webAudioGen);
    }
    var fa = window.__freshPlay(src, btn);
    window.__startPlaying(fa, btn);
    return new Promise(function(resolve) { fa.onended = resolve; });
};
</script>

<script>
function clearLastMargin(el) {
    if (!el) return;
    var items = [];
    for (var i = 0; i < el.children.length; i++) {
        var child = el.children[i];
        if (getComputedStyle(child).display === 'contents') {
            for (var j = 0; j < child.children.length; j++) items.push(child.children[j]);
        } else {
            items.push(child);
        }
    }
    var isVertical = getComputedStyle(el).writingMode === 'vertical-rl';
    items = items.filter(function(item) {
        if (getComputedStyle(item).display === 'none') return false;
        var r = item.getBoundingClientRect();
        // Skip zero-dimension elements (empty placeholders)
        if (isVertical ? r.width === 0 : r.height === 0) return false;
        return true;
    });
    if (!items.length) return;

    // Use bounding rects to find the item at the physical block-end edge,
    // instead of CSS order — handles wrapping flex and variable-width children.
    //   vertical-rl  → leftmost item  (smallest rect.left)  → clear marginLeft
    //   horizontal-tb → bottommost item (largest rect.bottom) → clear marginBottom
    var blockProp = isVertical ? 'marginLeft' : 'marginBottom';
    var blockEndItem = null;
    var blockEndVal = isVertical ? Infinity : -Infinity;
    for (var i = 0; i < items.length; i++) {
        var rect = items[i].getBoundingClientRect();
        var val = isVertical ? rect.left : rect.bottom;
        if (isVertical ? (val < blockEndVal) : (val > blockEndVal)) {
            blockEndVal = val;
            blockEndItem = items[i];
        }
    }
    if (blockEndItem) {
        blockEndItem.style[blockProp] = '0';
        blockEndItem.classList.add('debug-last');
    }

    // In vertical-rl, also clear inline-end (marginBottom) on the bottommost
    // item — same logic but for the inline axis.
    if (isVertical) {
        var inlineEndItem = null;
        var inlineEndVal = -Infinity;
        for (var i = 0; i < items.length; i++) {
            var rect = items[i].getBoundingClientRect();
            if (rect.bottom > inlineEndVal) {
                inlineEndVal = rect.bottom;
                inlineEndItem = items[i];
            }
        }
        if (inlineEndItem) {
            inlineEndItem.style.marginBottom = '0';
        }
    }
}
</script>

<script>
// Front-content: stamp data-side (both sides), populate (front only)
(function() {
    var _rs = getComputedStyle(document.documentElement);
    function setting(name, fallback) {
        var v = _rs.getPropertyValue(name);
        return v ? v.trim() : (fallback || '');
    }

    var wordSide = setting('--word-text', 'back');
    var sentSide = setting('--sentence-text', 'back');
    var imageSide = setting('--image', 'back');
    var wordAudioSide = setting('--word-audio', 'front');
    var sentAudioSide = setting('--sentence-audio', 'front');
    var wordFurigana = setting('--word-furigana', 'back');
    var sentFurigana = setting('--sentence-furigana', 'back');
    var wordPC = setting('--word-pitch-color', 'back');
    var sentPC = setting('--sentence-pitch-color', 'back');
    // Backwards compat: treat 'on' or any unknown value as 'back'
    wordPC = (wordPC === 'front') ? 'front' : (wordPC === 'off') ? 'off' : 'back';
    sentPC = (sentPC === 'front') ? 'front' : (sentPC === 'off') ? 'off' : 'back';

    // ── Stamp data-side on front-content elements (both front and back) ──
    var frontWord = document.getElementById('front-word');
    var frontSent = document.getElementById('front-sentence');
    var frontImage = document.getElementById('front-image');

    if (frontWord) frontWord.setAttribute('data-side',
        wordSide === 'front' ? 'front' : (wordSide === 'off' ? 'off' : 'back'));
    if (frontSent) frontSent.setAttribute('data-side',
        sentSide === 'front' ? 'front' : (sentSide === 'off' ? 'off' : 'back'));
    if (frontImage) frontImage.setAttribute('data-side',
        imageSide === 'front' ? 'front' : (imageSide === 'off' ? 'off' : 'back'));

    // ── Stamp data-side on audio items (both front and back) ──
    var wordAI = document.querySelector('.audio-row .audio-item[data-audio="word"]');
    var sentAI = document.querySelector('.audio-row .audio-item[data-audio="sentence"]');
    if (wordAI) wordAI.setAttribute('data-side', wordAudioSide);
    if (sentAI) sentAI.setAttribute('data-side', sentAudioSide);

    // ── Shared: available on both front and back (via window) ──
    window.escapeBrackets = function(text) {
        text = text.replace(/\\ /g, '&nbsp;');
        text = text.replace(/\\\[/g, '\u2045').replace(/\\\]/g, '\u2046');
        text = text.replace(/ +(\[[^\]]*\])/g, function(m, b) {
            return '&nbsp;\u2045' + b.slice(1, -1) + '\u2046';
        });
        text = text.replace(/\u2046 +/g, '\u2046&nbsp;');
        return text;
    };

    window.textToRuby = function(fragment) {
        fragment = fragment.replace(/\[(\d+)\]/g, '\u2045$1\u2046');
        var re = /([^\[\]]+)\[([^\]]+)\]/g;
        var result = '', lastIndex = 0, match;
        while ((match = re.exec(fragment)) !== null) {
            if (match.index > lastIndex) result += fragment.slice(lastIndex, match.index);
            var reading = match[2];
            if (reading.indexOf('|') !== -1) {
                var front = reading.split('|')[0];
                if (!front) { result += match[1]; lastIndex = re.lastIndex; continue; }
                result += '<ruby>' + match[1] + '<rt data-split>' + front + '</rt></ruby>';
            } else if (/[\u3040-\u309F\u30A0-\u30FFa-zA-Z]/.test(reading)) {
                result += '<ruby>' + match[1] + '<rt>' + reading + '</rt></ruby>';
            } else {
                result += match[1];
            }
            lastIndex = re.lastIndex;
        }
        if (lastIndex < fragment.length) result += fragment.slice(lastIndex);
        return result.replace(/\u2045/g, '[').replace(/\u2046/g, ']')
                     .replace(/\[(\d+)\]/g, '<span class="pitch-num">$1</span>');
    };

    // ── Everything below is front-only ──
    if (document.querySelector('.back')) return;

    // ── plainRuby: bracket notation → <ruby>, no accent colors ──
    function plainRuby(raw) {
        if (!raw) return '';
        raw = raw.replace(/<[^>]+>/g, ' ');
        raw = escapeBrackets(raw);
        var tokens = raw.split(/[\s\t\u3000]+/).filter(Boolean);
        var out = [];
        for (var i = 0; i < tokens.length; i++) {
            var t = tokens[i];
            if (/^[;|\.\/／\-]+$/.test(t)) continue;
            if (t === ',' || t === '\u3001' || t === '\u300C' || t === '\u300D') { out.push(t); continue; }
            t = t.replace(/:[a-zA-Z0-9~,\-]*$/, '');
            t = t.replace(/[\*\\\^]/g, '');
            out.push(textToRuby(t));
        }
        return out.join('');
    }

    // ── coloredRuby: bracket notation → <ruby> with accent-color spans ──
    function coloredRuby(raw) {
        if (!raw) return '';
        raw = raw.replace(/<[^>]+>/g, ' ');
        raw = escapeBrackets(raw);
        var tokens = raw.split(/[\s\t\u3000]+/).filter(Boolean);
        var roleMap = {
            h: 'heiban', a: 'atamadaka', n: 'nakadaka', o: 'odaka', k: 'kifuku',
            H: 'keihan_heiban', A: 'keihan_atamadaka', N: 'keihan_nakadaka',
            L: 'keihan_low_heiban', M: 'keihan_low_nakadaka', O: 'keihan_low_odaka'
        };
        function accentClass(accent) {
            if (!accent) return '';
            var km = accent.match(/^([a-zA-Z]{1,2}):([hlHL]+)$/);
            if (km) return roleMap[km[1]] || '';
            var tm = accent.match(/^p?([a-zA-Z])?~?(\d)?~?$/);
            if (!tm) return '';
            if (tm[1] && roleMap[tm[1]]) return roleMap[tm[1]];
            if (tm[2] !== undefined) {
                var n = parseInt(tm[2]);
                return n === 0 ? 'heiban' : n === 1 ? 'atamadaka' : 'nakadaka';
            }
            if (tm[1] === 'p') return 'particle';
            return '';
        }
        var SEPS = [',', '\u3001', '\u300C', '\u300D'];
        var out = [], pending = [];
        for (var i = 0; i < tokens.length; i++) {
            var t = tokens[i];
            if (/^[;|\.\/／\-]+$/.test(t)) continue;
            if (SEPS.indexOf(t) !== -1) {
                if (pending.length) { out.push(pending.join('')); pending = []; }
                out.push(t);
                continue;
            }
            var colonIdx = t.indexOf(':');
            var cls = '';
            var wordPart = t;
            if (colonIdx !== -1) {
                wordPart = t.substring(0, colonIdx);
                cls = accentClass(t.substring(colonIdx + 1).split(',')[0]);
            }
            var html = textToRuby(wordPart.replace(/[\*\\\^]/g, ''));
            if (colonIdx === -1) {
                pending.push(html);
            } else {
                var merged = pending.join('') + html;
                pending = [];
                out.push(cls ? '<span class="' + cls + '">' + merged + '</span>' : merged);
            }
        }
        if (pending.length) out.push(pending.join(''));
        return out.join('');
    }

    // ── Populate front-content children (front only) ──
    if (wordSide === 'front') {
        var rw = document.getElementById('raw-word');
        var html = rw ? (wordPC === 'front' ? coloredRuby : plainRuby)(rw.textContent.trim()) : '';
        if (html) {
            frontWord.innerHTML = html;
            if (wordPC === 'front') frontWord.classList.add('pitch-color-front');
        } else { frontWord.setAttribute('data-side', 'back'); }
    }

    if (sentSide === 'front') {
        var rs = document.getElementById('raw-sentence');
        var html = rs ? (sentPC === 'front' ? coloredRuby : plainRuby)(rs.textContent.trim()) : '';
        if (html) {
            frontSent.innerHTML = html;
            if (sentPC === 'front') frontSent.classList.add('pitch-color-front');
        } else { frontSent.setAttribute('data-side', 'back'); }
    }

    if (imageSide === 'front') {
        var ri = document.getElementById('raw-image');
        if (ri && ri.innerHTML.trim()) { frontImage.innerHTML = ri.innerHTML; }
        else { frontImage.setAttribute('data-side', 'back'); }
    }
    if (window.__checkImageFit) window.__checkImageFit();

    if (wordFurigana !== 'back') frontWord.classList.add('furigana-' + wordFurigana);
    if (sentFurigana !== 'back') frontSent.classList.add('furigana-' + sentFurigana);

    // ── Front-side text-play linkage ──
    if (wordSide === 'front' && wordAudioSide === 'front' && frontWord.innerHTML) {
        window.__linkTextPlay(frontWord, 'word', {
            getAudioSrc: function() {
                var item = document.querySelector('.audio-item[data-audio="word"][data-side="front"]');
                if (!item) return null;
                if (item._jsAudios && item._jsAudios[0]) return item._jsAudios[0].src;
                var a = item.querySelector('audio');
                return a ? a.src : null;
            },
            getBtn: function() {
                return document.querySelector('.audio-item[data-audio="word"] .replay-button');
            },
            getAllBtns: function() {
                return Array.from(document.querySelectorAll('.audio-item[data-audio="word"] .replay-button'));
            }
        });
    }

    if (sentSide === 'front' && sentAudioSide === 'front' && frontSent.innerHTML) {
        window.__linkTextPlay(frontSent, 'sentence', {
            getAudioSrc: function() {
                var item = document.querySelector('.audio-item[data-audio="sentence"][data-side="front"]');
                if (!item) return null;
                if (item._jsAudios && item._jsAudios[0]) return item._jsAudios[0].src;
                var a = item.querySelector('audio');
                return a ? a.src : null;
            },
            getBtn: function() {
                return document.querySelector('.audio-item[data-audio="sentence"] .replay-button');
            },
            getAllBtns: function() {
                return Array.from(document.querySelectorAll('.audio-item[data-audio="sentence"] .replay-button'));
            }
        });
    }

    // Only clear last margins when front has visible content — in the
    // audio-only case the audio-row's margin-bottom provides symmetric
    // spacing and must be preserved.
    var hasFrontContent = !!document.querySelector('.front-content [data-side="front"]');
    if (hasFrontContent) clearLastMargin(document.querySelector('.front'));
    // Only clear inside .front-content when it is itself the last visible
    // child of .front (no audio row below it); otherwise the sentence
    // needs its margin to separate from the audio row.
    var fc = document.querySelector('.front-content');
    if (hasFrontContent && fc && fc.classList.contains('debug-last')) {
        // In tategaki the audio row sits to the LEFT of front-content,
        // which is the visual terminal position. clearLastMargin can't
        // detect this (both children share order:0, DOM tiebreak picks
        // front-content). Move the marker to the audio row instead.
        var ar = document.querySelector('.front > .audio-row');
        if (document.documentElement.classList.contains('tategaki')
            && ar && getComputedStyle(ar).display !== 'none') {
            fc.classList.remove('debug-last');
            fc.style.marginBottom = '';
            ar.style.marginBottom = '0';
            ar.classList.add('debug-last');
        } else {
            fc.classList.remove('debug-last');
            fc.style.marginBottom = '';
            clearLastMargin(fc);
        }
    }

    // ── Adjust front padding for added content (mobile only) ──
    // lock() sets paddingTop before data-side is stamped; clear it now if
    // front-content has visible items (padding is only for audio-only fronts).
    if (window.matchMedia('(hover: none)').matches) {
        var fc = document.querySelector('.front-content');
        var fr = document.querySelector('.front');
        if (fc && fr && fr.style.paddingTop) {
            if (fr.querySelector('.front-content [data-side="front"]')) {
                fr.style.paddingTop = '';
            } else {
                var contentH = fc.offsetHeight;
                if (contentH > 0) {
                    var curPad = parseInt(fr.style.paddingTop) || 0;
                    fr.style.paddingTop = Math.max(0, curPad - contentH) + 'px';
                }
            }
        }
    }

})();
</script>

<script>
// Center hyphens between pitch-num glyphs (Latin baseline sits too low next to them)
(function() {
    var glyphs = document.querySelectorAll('.front-content .pitch-num');
    for (var i = 0; i < glyphs.length; i++) {
        var node = glyphs[i].nextSibling;
        if (node && node.nodeType === 3 && node.nodeValue.trim() === '-'
            && node.nextSibling && node.nextSibling.classList
            && node.nextSibling.classList.contains('pitch-num')) {
            var span = document.createElement('span');
            span.className = 'hc';
            span.textContent = node.nodeValue;
            node.parentNode.replaceChild(span, node);
        }
    }
})();
</script>

<script>
// Replace native <audio> players or [audio:] tags with styled replay buttons
(function() {
  var SVG = window.__audioSVG;
  var animateBtn = window.__animateBtn;
  document.querySelectorAll('.audio-row .audio-item').forEach(function(item) {
    // [audio:] custom tags — extract filename, create Audio + button
    var text = item.textContent;
    var audioRe = /\[audio:([^\]]+)\]/g;
    var audioMatch = audioRe.exec(text);
    if (audioMatch) {
      var filenames = [];
      do { filenames.push(audioMatch[1].replace(/#/g, '%23').replace(/\?/g, '%3F')); }
      while ((audioMatch = audioRe.exec(text)) !== null);
      // Remove everything except .audio-label (text nodes, <br>, stray HTML)
      Array.from(item.childNodes).forEach(function(n) {
        if (n.nodeType === 3 || !n.classList || !n.classList.contains('audio-label'))
          item.removeChild(n);
      });
      item._jsAudios = [];
      for (var k = 0; k < filenames.length; k++) {
        var audio = document.createElement('audio');
        audio.preload = 'auto';
        audio.src = filenames[k];
        document.body.appendChild(audio);
        item._jsAudios.push(audio);
        var btn = document.createElement('a');
        btn.className = 'replay-button soundLink';
        btn.href = '#';
        btn.innerHTML = SVG;
        item.insertBefore(btn, item.firstChild);
        (function(a, b) {
          window.__onTap(b, function() {
            if (window.matchMedia('(hover: none)').matches) {
              window.__stopAllAudio();
              animateBtn(b);
              window.__playMobile(a.src, b);
            } else {
              window.__stopAllAudio(a);
              a.currentTime = 0;
              window.__safePlay(a);
              animateBtn(b);
              window.__startPlaying(a, b);
            }
          }, function() { window.__stopAllAudio(); });
        })(audio, btn);
      }
      return;
    }
    // [sound:] native
    if (item.querySelector('.replay-button')) return;
    var nativeAudio = item.querySelector('audio');
    if (!nativeAudio) return;
    // Remove non-audio junk (text nodes, <br>, stray HTML)
    Array.from(item.childNodes).forEach(function(n) {
      if (n.nodeType === 3 || (n.nodeType === 1 && n.tagName !== 'AUDIO'
          && (!n.classList || !n.classList.contains('audio-label'))))
        item.removeChild(n);
    });
    nativeAudio.style.display = 'none';
    nativeAudio.removeAttribute('controls');
    var btn = document.createElement('a');
    btn.className = 'replay-button soundLink';
    btn.href = '#';
    btn.innerHTML = SVG;
    item.insertBefore(btn, item.firstChild);
    window.__onTap(btn, function() {
      if (window.matchMedia('(hover: none)').matches) {
        window.__stopAllAudio();
        animateBtn(btn);
        window.__playMobile(nativeAudio.src, btn);
      } else {
        window.__stopAllAudio(nativeAudio);
        nativeAudio.currentTime = 0;
        window.__safePlay(nativeAudio);
        animateBtn(btn);
        window.__startPlaying(nativeAudio, btn);
      }
    }, function() { window.__stopAllAudio(); });
  });

  // Link button→text hover for front-side text-play
  if (window.__linkBtnHoverToText) {
    document.querySelectorAll('.audio-row .audio-item').forEach(function(item) {
      var audioType = item.getAttribute('data-audio');
      if (!audioType) return;
      item.querySelectorAll('.replay-button').forEach(function(btn) {
        window.__linkBtnHoverToText(btn, audioType);
      });
    });
  }
})();
</script>

<script>
// Autoplay audio items in sequence (front side only)
(function() {
  if (document.querySelector('.back')) return;
  var items = document.querySelectorAll('.audio-row .audio-item[data-side="front"]');
  var queue = [];
  var animateBtn = window.__animateBtn;
  items.forEach(function(item) {
    if (item._jsAudios) {
      var btns = item.querySelectorAll('.replay-button');
      for (var j = 0; j < item._jsAudios.length; j++)
        queue.push({ audio: item._jsAudios[j], btn: btns[j], js: true });
    } else {
      var audio = item.querySelector('audio');
      var btn = item.querySelector('.replay-button');
      if (audio) queue.push({ audio: audio, btn: btn, js: false });
    }
  });
  if (!queue.length) return;
  var i = 0;
  setTimeout(function() {
    var gen = window.__webAudioGen;
    (function playNext() {
      if (i >= queue.length || gen !== window.__webAudioGen) return;
      var entry = queue[i++];
      if (entry.btn) animateBtn(entry.btn);
      window.__playMobile(entry.audio.src, entry.btn)
          .then(function() { if (gen === window.__webAudioGen) playNext(); })
          ['catch'](function() { if (gen === window.__webAudioGen) playNext(); });
    })();
  }, 0);
})();
</script>

<script>
(function() {
  var HANDLER_KEY = '__audioHandler';
  var animateBtn = window.__animateBtn;
  var _lastKey = null, _lastKeyTime = 0, _DBL_MS = 350;
  var _rs = getComputedStyle(document.documentElement);
  var K_WORD = (_rs.getPropertyValue('--hotkey-word-audio').trim() || 'n').toLowerCase();
  var K_SENT = (_rs.getPropertyValue('--hotkey-sentence-audio').trim() || 'h').toLowerCase();
  var K_ALL  = (_rs.getPropertyValue('--hotkey-play-all').trim() || 'z').toLowerCase();
  var K_STOP = _rs.getPropertyValue('--hotkey-stop-all').trim() || '?';
  function isDbl(key) {
    var now = Date.now();
    if (_lastKey === key && now - _lastKeyTime < _DBL_MS) { _lastKey = null; _lastKeyTime = 0; return true; }
    _lastKey = key; _lastKeyTime = now; return false;
  }
  function play(item) {
    if (!item) return;
    window.__stopAllAudio();
    var link = item.querySelector('.soundLink');
    if (link) {
      link.click();
      var btn = item.querySelector('.replay-button');
      if (btn) animateBtn(btn);
      return;
    }
    var audio = item.querySelector('audio');
    if (audio) { audio.currentTime = 0; window.__safePlay(audio); }
  }
  function playAll() {
    var isBack = !!document.querySelector('.back');
    var items = document.querySelectorAll('.audio-row .audio-item' + (isBack ? '' : '[data-side="front"]'));
    var queue = [];
    items.forEach(function(item) {
      if (item._jsAudios) {
        var btns = item.querySelectorAll('.replay-button');
        for (var j = 0; j < item._jsAudios.length; j++)
          queue.push({ audio: item._jsAudios[j], btn: btns[j], js: true });
      } else {
        var audio = item.querySelector('audio');
        var btn = item.querySelector('.replay-button');
        if (audio) queue.push({ audio: audio, btn: btn, js: false });
      }
    });
    if (!queue.length) return false;
    window.__stopAllAudio();
    var k = 0;
    function next() {
      if (k >= queue.length) return;
      var entry = queue[k++];
      entry.audio.currentTime = 0;
      window.__safePlay(entry.audio);
      if (entry.btn) animateBtn(entry.btn);
      if (entry.js) window.__startPlaying(entry.audio, entry.btn);
      entry.audio.onended = entry.audio.onerror = next;
    }
    next();
    return true;
  }
  function handler(ev) {
    var el = ev.target;
    if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable)) return;
    var isBack = !!document.querySelector('.back');
    var sf = isBack ? '' : '[data-side="front"]';
    var wordItem = document.querySelector('.audio-row .audio-item[data-audio="word"]' + sf);
    var sentItem = document.querySelector('.audio-row .audio-item[data-audio="sentence"]' + sf);
    var k = ev.key.toLowerCase();
    if (k === K_WORD) { ev.preventDefault(); ev.stopPropagation(); if (isDbl(K_WORD)) window.__stopAllAudio(); else play(wordItem); }
    else if (k === K_SENT) { ev.preventDefault(); ev.stopPropagation(); if (isDbl(K_SENT)) window.__stopAllAudio(); else play(sentItem); }
    else if (k === K_ALL) { if (playAll()) { ev.preventDefault(); ev.stopPropagation(); } }
    else if (k === K_STOP) { ev.preventDefault(); ev.stopPropagation(); if (window.__stopAllAudio) window.__stopAllAudio(); }
  }
  if (window[HANDLER_KEY]) {
    window.removeEventListener('keydown', window[HANDLER_KEY], true);
  }
  window[HANDLER_KEY] = handler;
  window.addEventListener('keydown', handler, { capture: true });

  // Stop all audio when a native [sound:] replay button is tapped on mobile
  var audioRow = document.querySelector('.audio-row');
  if (audioRow) {
    audioRow.addEventListener('click', function(ev) {
      var btn = ev.target.closest('.replay-button');
      if (btn && !btn._hasHandler) window.__stopAllAudio();
    }, true);
  }
})();
</script>
</div>
