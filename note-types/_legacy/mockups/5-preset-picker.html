<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mockup 5: Preset Picker with Tag/Deck Mapping</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #1e1e2e; color: #cdd6f4; padding: 20px; }
  h1 { font-size: 18px; margin-bottom: 4px; color: #cba6f7; }
  .subtitle { font-size: 13px; color: #a6adc8; margin-bottom: 16px; }

  .two-stage { display: flex; gap: 0; height: calc(100vh - 140px); }

  /* Stage 1: Presets */
  .stage {
    flex: 1; display: flex; flex-direction: column;
    border: 1px solid #45475a; overflow: hidden;
  }
  .stage:first-child { border-radius: 12px 0 0 12px; border-right: none; }
  .stage:last-child { border-radius: 0 12px 12px 0; }

  .stage-header {
    padding: 14px 16px; background: #313244; border-bottom: 1px solid #45475a;
  }
  .stage-header h2 {
    font-size: 14px; font-weight: 700; margin-bottom: 2px;
  }
  .stage-header h2 .step-num {
    display: inline-block; background: #cba6f7; color: #1e1e2e;
    width: 22px; height: 22px; line-height: 22px; border-radius: 50%;
    text-align: center; font-size: 12px; margin-right: 6px;
  }
  .stage-header p { font-size: 12px; color: #a6adc8; }

  .stage-body { flex: 1; overflow-y: auto; padding: 12px; }

  /* Preset cards */
  .preset-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 10px;
  }
  .preset-card {
    background: #313244; border: 2px solid #45475a; border-radius: 10px;
    padding: 14px; cursor: pointer; transition: all 0.15s;
  }
  .preset-card:hover { border-color: #585b70; background: #3a3a4e; }
  .preset-card.selected { border-color: #cba6f7; background: #3a3a4e; }

  .preset-card .preset-name {
    font-size: 14px; font-weight: 700; margin-bottom: 6px;
    display: flex; align-items: center; gap: 8px;
  }
  .preset-card .preset-name .edit-name {
    background: none; border: none; color: #cdd6f4; font-size: 14px; font-weight: 700;
    flex: 1; padding: 0; cursor: text;
  }
  .preset-card .preset-name .edit-name:focus { outline: none; border-bottom: 1px solid #cba6f7; }

  .preset-card .preset-desc {
    font-size: 12px; color: #a6adc8; margin-bottom: 10px; line-height: 1.4;
  }

  .preset-changes {
    display: flex; flex-wrap: wrap; gap: 4px;
  }
  .change-pill {
    background: #2a3a2a; border: 1px solid #a6e3a144; color: #a6e3a1;
    padding: 2px 8px; border-radius: 10px; font-size: 11px;
    display: flex; align-items: center; gap: 4px;
  }
  .change-pill .arrow { color: #6c7086; }

  .preset-card .edit-btn {
    margin-top: 8px; background: none; border: 1px solid #585b70; color: #a6adc8;
    padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; width: 100%;
  }
  .preset-card .edit-btn:hover { border-color: #cba6f7; color: #cba6f7; }

  .add-preset-card {
    background: none; border: 2px dashed #45475a; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    padding: 24px; color: #cba6f7; cursor: pointer; font-size: 14px;
    min-height: 100px;
  }
  .add-preset-card:hover { border-color: #cba6f7; background: #31324444; }

  /* Preset editor modal */
  .preset-editor-overlay {
    display: none; position: fixed; inset: 0; background: #00000088; z-index: 100;
    align-items: center; justify-content: center;
  }
  .preset-editor-overlay.open { display: flex; }
  .preset-editor {
    background: #1e1e2e; border: 1px solid #45475a; border-radius: 12px;
    width: 600px; max-height: 80vh; overflow-y: auto; padding: 20px;
  }
  .preset-editor h3 { font-size: 15px; color: #cba6f7; margin-bottom: 12px; }
  .preset-editor .close-btn {
    float: right; background: none; border: none; color: #a6adc8;
    cursor: pointer; font-size: 18px;
  }

  .pe-group { margin-bottom: 12px; }
  .pe-group-title { font-size: 12px; font-weight: 700; color: #a6adc8; margin-bottom: 6px; text-transform: uppercase; }
  .pe-setting {
    display: flex; align-items: center; padding: 4px 0; gap: 8px;
  }
  .pe-setting input[type="checkbox"] { accent-color: #a6e3a1; }
  .pe-setting label { font-size: 13px; flex: 1; }
  .pe-setting select {
    background: #45475a; border: 1px solid #585b70; color: #cdd6f4;
    padding: 3px 8px; border-radius: 4px; font-size: 12px;
  }
  .pe-setting select:disabled { opacity: 0.3; }
  .pe-setting select.active { border-color: #a6e3a1; color: #a6e3a1; }
  .pe-save-btn {
    margin-top: 12px; background: #cba6f7; color: #1e1e2e; border: none;
    padding: 8px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;
  }
  .pe-save-btn:hover { background: #b4befe; }
  .pe-delete-btn {
    margin-top: 12px; margin-left: 8px; background: none; border: 1px solid #f38ba8;
    color: #f38ba8; padding: 8px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;
  }
  .pe-delete-btn:hover { background: #f38ba8; color: #1e1e2e; }

  /* Stage 2: Mapping */
  .mapping-list {
    display: flex; flex-direction: column; gap: 6px;
  }
  .mapping-row {
    display: flex; align-items: center; gap: 8px; padding: 10px 12px;
    background: #313244; border-radius: 8px;
  }
  .mapping-row .mapping-num {
    width: 24px; height: 24px; line-height: 24px; border-radius: 50%;
    background: #f9e2af; color: #1e1e2e; font-weight: 700; font-size: 12px;
    text-align: center; flex-shrink: 0;
  }
  .mapping-row .mapping-preset {
    background: #cba6f733; border: 1px solid #cba6f744; color: #cba6f7;
    padding: 4px 10px; border-radius: 6px; font-size: 13px; font-weight: 600;
    min-width: 90px; text-align: center;
  }
  .mapping-row .mapping-arrow { color: #585b70; font-size: 16px; }
  .mapping-row .mapping-triggers { flex: 1; display: flex; gap: 6px; flex-wrap: wrap; }
  .mapping-row input {
    background: #45475a; border: 1px solid #585b70; border-radius: 6px;
    color: #cdd6f4; padding: 5px 10px; font-size: 12px; flex: 1; min-width: 120px;
  }
  .mapping-row input:focus { border-color: #cba6f7; outline: none; }
  .mapping-row input.tag-input { border-color: #89b4fa44; }
  .mapping-row input.deck-input { border-color: #f9e2af44; }
  .mapping-row select.preset-select {
    background: #45475a; border: 1px solid #585b70; color: #cdd6f4;
    padding: 5px 10px; border-radius: 6px; font-size: 12px; min-width: 120px;
  }
  .mapping-row .remove-mapping {
    background: none; border: none; color: #f38ba8; cursor: pointer; font-size: 16px;
    padding: 2px 6px;
  }
  .mapping-row .remove-mapping:hover { background: #f38ba822; border-radius: 4px; }

  .add-mapping-btn {
    margin-top: 8px; padding: 10px; background: none; border: 2px dashed #45475a;
    border-radius: 8px; color: #cba6f7; cursor: pointer; font-size: 13px;
    text-align: center; width: 100%;
  }
  .add-mapping-btn:hover { border-color: #cba6f7; }

  .priority-note {
    margin-top: 8px; font-size: 11px; color: #6c7086; text-align: center; padding: 0 12px;
  }

  .concept-note {
    margin-top: 16px; padding: 12px 16px; background: #313244;
    border-radius: 8px; border-left: 3px solid #cba6f7; font-size: 13px; line-height: 1.5;
  }
  .concept-note strong { color: #cba6f7; }
</style>
</head>
<body>

<h1>Concept 5: Preset Picker + Mapping</h1>
<p class="subtitle">Two-stage approach: first define reusable presets (bundles of overrides), then map them to tags/decks.</p>

<div class="two-stage">
  <div class="stage">
    <div class="stage-header">
      <h2><span class="step-num">1</span>Define Presets</h2>
      <p>Create named bundles of setting overrides. Each preset is reusable.</p>
    </div>
    <div class="stage-body" id="presetsBody"></div>
  </div>
  <div class="stage">
    <div class="stage-header">
      <h2><span class="step-num">2</span>Map to Tags & Decks</h2>
      <p>Assign presets to specific tags or decks. Order = priority (top = highest).</p>
    </div>
    <div class="stage-body" id="mappingsBody"></div>
  </div>
</div>

<div id="editorOverlay" class="preset-editor-overlay"></div>

<div class="concept-note">
  <strong>How it works:</strong> A two-stage workflow separating "what" from "where."
  Stage 1: Define named presets â€” reusable bundles of overrides (e.g., "Sentence Mode" = tategaki + no furigana).
  Stage 2: Map presets to tags/decks with priority ordering. One preset can be used by multiple mappings.
  <br><br>
  <strong>Pros:</strong> Very clean separation of concerns. Reusable presets reduce duplication â€” change a preset
  once and it updates everywhere. The mapping stage is dead simple.<br>
  <strong>Cons:</strong> Two-step process might feel overly abstracted. Indirection can be confusing â€”
  "which preset is this tag using again?" Slightly more complex mental model.
</div>

<script>
const GROUPS = {
  'Layout': [
    { key: 'tategaki', label: 'Tategaki', opts: ['off','on'], def: 'off' },
    { key: 'color-scheme', label: 'Color Scheme', opts: ['blue','black','red','purple','white'], def: 'blue' },
    { key: 'audio-labels', label: 'Audio Labels', opts: ['on','off'], def: 'on' },
  ],
  'Word': [
    { key: 'word', label: 'Word', opts: ['front','back','off'], def: 'front' },
    { key: 'word-audio', label: 'Word Audio', opts: ['front','back','off'], def: 'back' },
    { key: 'word-furigana', label: 'Furigana', opts: ['front','back','off'], def: 'front' },
    { key: 'word-pitch-color', label: 'Pitch Color', opts: ['front','back','off'], def: 'back' },
    { key: 'pitch-graph', label: 'Pitch Graph', opts: ['on','off'], def: 'on' },
  ],
  'Sentence': [
    { key: 'sentence', label: 'Sentence', opts: ['front','back','off'], def: 'front' },
    { key: 'sentence-audio', label: 'Sentence Audio', opts: ['front','back','off'], def: 'back' },
    { key: 'sentence-furigana', label: 'Furigana', opts: ['front','back','off'], def: 'front' },
    { key: 'sentence-pitch-color', label: 'Pitch Color', opts: ['front','back','off'], def: 'back' },
  ],
  'Image': [
    { key: 'image', label: 'Image', opts: ['front','back','off'], def: 'back' },
  ],
  'Definitions': [
    { key: 'definition-mode', label: 'Definition Mode', opts: ['all','bilingual','monolingual','unlocked'], def: 'all' },
    { key: 'definition-text', label: 'Definition Text', opts: ['on','off'], def: 'on' },
    { key: 'definition-furigana', label: 'Furigana', opts: ['front','back','off'], def: 'back' },
    { key: 'definition-pitch-color', label: 'Pitch Color', opts: ['front','back','off'], def: 'back' },
  ],
};
const ALL_SETTINGS = [].concat(...Object.values(GROUPS));

let presets = [
  { id: 1, name: 'Sentence Mode', desc: 'Vertical layout for sentence cards', overrides: { tategaki:'on', 'word-furigana':'back', 'sentence-furigana':'back' } },
  { id: 2, name: 'Image Front', desc: 'Show image on front side', overrides: { image:'front' } },
  { id: 3, name: 'Knowledge', desc: 'Monolingual definitions only', overrides: { tategaki:'on', 'definition-mode':'monolingual' } },
  { id: 4, name: 'Keihan', desc: 'Red color scheme for Keihan dialect', overrides: { 'color-scheme':'red' } },
  { id: 5, name: 'Full Furigana', desc: 'Show furigana everywhere', overrides: { 'word-furigana':'front', 'sentence-furigana':'front', 'definition-furigana':'front' } },
];

let mappings = [
  { presetId: 1, tag: '_jp::sentence', deck: '1. ðŸ‡¯ðŸ‡µ::ðŸ“– ä¾‹æ–‡' },
  { presetId: 2, tag: '_jp::image', deck: '' },
  { presetId: 3, tag: '_jp::knowledge', deck: '1. ðŸ‡¯ðŸ‡µ::ðŸ“š é›‘å­¦' },
  { presetId: 4, tag: '_jp::keihan', deck: '' },
  { presetId: 5, tag: '_jp::furigana', deck: '' },
];

let nextId = 6;

function renderPresets() {
  const body = document.getElementById('presetsBody');
  let html = '<div class="preset-grid">';

  for (const p of presets) {
    const overrideEntries = Object.entries(p.overrides);
    html += `
      <div class="preset-card" onclick="editPreset(${p.id})">
        <div class="preset-name">
          <span style="font-size:16px">ðŸ“‹</span>
          ${p.name}
        </div>
        <div class="preset-desc">${p.desc || 'No description'}</div>
        <div class="preset-changes">
          ${overrideEntries.map(([k, v]) => {
            const s = ALL_SETTINGS.find(s => s.key === k);
            return `<span class="change-pill">${s ? s.label : k} <span class="arrow">â†’</span> ${v}</span>`;
          }).join('')}
          ${overrideEntries.length === 0 ? '<span style="color:#6c7086;font-size:12px">No overrides set</span>' : ''}
        </div>
        <button class="edit-btn">Edit Overrides</button>
      </div>
    `;
  }

  html += `<div class="add-preset-card" onclick="addPreset()">+ Create New Preset</div>`;
  html += '</div>';
  body.innerHTML = html;
}

function renderMappings() {
  const body = document.getElementById('mappingsBody');
  let html = '<div class="mapping-list">';

  mappings.forEach((m, idx) => {
    const preset = presets.find(p => p.id === m.presetId);
    html += `
      <div class="mapping-row">
        <div class="mapping-num">${idx + 1}</div>
        <select class="preset-select" onchange="mappings[${idx}].presetId=parseInt(this.value); renderMappings();">
          ${presets.map(p => `<option value="${p.id}" ${p.id===m.presetId?'selected':''}>${p.name}</option>`).join('')}
        </select>
        <span class="mapping-arrow">â†’</span>
        <div class="mapping-triggers">
          <input class="tag-input" type="text" value="${m.tag}" oninput="mappings[${idx}].tag=this.value" placeholder="Tag (e.g. _jp::sentence)">
          <input class="deck-input" type="text" value="${m.deck}" oninput="mappings[${idx}].deck=this.value" placeholder="Deck prefix (optional)">
        </div>
        <button class="remove-mapping" onclick="mappings.splice(${idx},1); renderMappings();" title="Remove">âœ•</button>
      </div>
    `;
  });

  html += '</div>';
  html += `<button class="add-mapping-btn" onclick="addMapping()">+ Add Mapping</button>`;
  html += `<p class="priority-note">Priority: #1 is highest. Tag matches always beat deck matches regardless of position.</p>`;
  body.innerHTML = html;
}

function editPreset(id) {
  const p = presets.find(p => p.id === id);
  if (!p) return;

  const overlay = document.getElementById('editorOverlay');
  let html = `<div class="preset-editor">
    <button class="close-btn" onclick="closeEditor()">âœ•</button>
    <h3>Edit Preset: ${p.name}</h3>
    <div style="margin-bottom:12px">
      <input type="text" value="${p.name}" id="pe-name" style="background:#45475a;border:1px solid #585b70;border-radius:6px;color:#cdd6f4;padding:6px 10px;font-size:14px;width:100%;font-weight:600" placeholder="Preset name">
    </div>
    <div style="margin-bottom:12px">
      <input type="text" value="${p.desc}" id="pe-desc" style="background:#45475a;border:1px solid #585b70;border-radius:6px;color:#cdd6f4;padding:6px 10px;font-size:13px;width:100%" placeholder="Description (optional)">
    </div>
  `;

  for (const [groupName, settings] of Object.entries(GROUPS)) {
    html += `<div class="pe-group"><div class="pe-group-title">${groupName}</div>`;
    for (const s of settings) {
      const isActive = s.key in p.overrides;
      html += `
        <div class="pe-setting">
          <input type="checkbox" id="pe-${s.key}" ${isActive?'checked':''}
            onchange="togglePresetSetting(${id},'${s.key}','${s.def}',this.checked)">
          <label for="pe-${s.key}">${s.label}</label>
          <select ${isActive?'class="active"':'disabled'} id="sel-${s.key}"
            onchange="setPresetSetting(${id},'${s.key}',this.value)">
            ${s.opts.map(o => `<option value="${o}" ${isActive&&p.overrides[s.key]===o?'selected':''}>${o}</option>`).join('')}
          </select>
        </div>
      `;
    }
    html += '</div>';
  }

  html += `<div>
    <button class="pe-save-btn" onclick="savePresetEditor(${id})">Done</button>
    <button class="pe-delete-btn" onclick="deletePreset(${id})">Delete Preset</button>
  </div></div>`;

  overlay.innerHTML = html;
  overlay.classList.add('open');
}

function closeEditor() {
  document.getElementById('editorOverlay').classList.remove('open');
  renderPresets();
}

function togglePresetSetting(id, key, def, checked) {
  const p = presets.find(p => p.id === id);
  if (checked) {
    p.overrides[key] = def;
  } else {
    delete p.overrides[key];
  }
  editPreset(id); // re-render editor
}

function setPresetSetting(id, key, val) {
  const p = presets.find(p => p.id === id);
  p.overrides[key] = val;
}

function savePresetEditor(id) {
  const p = presets.find(p => p.id === id);
  p.name = document.getElementById('pe-name').value || 'Untitled';
  p.desc = document.getElementById('pe-desc').value || '';
  closeEditor();
  renderMappings();
}

function deletePreset(id) {
  presets = presets.filter(p => p.id !== id);
  mappings = mappings.filter(m => m.presetId !== id);
  closeEditor();
  renderPresets();
  renderMappings();
}

function addPreset() {
  const newId = nextId++;
  presets.push({ id: newId, name: 'New Preset', desc: '', overrides: {} });
  renderPresets();
  editPreset(newId);
}

function addMapping() {
  if (presets.length === 0) { addPreset(); return; }
  mappings.push({ presetId: presets[0].id, tag: '', deck: '' });
  renderMappings();
}

renderPresets();
renderMappings();
</script>
</body>
</html>
