<div class="card-inner">
<div class="back">
    {{FrontSide}}

    {{#Definition Audio}}
    <div id="def-audio-container" style="display:none">{{Definition Audio}}</div>
    {{/Definition Audio}}

    <script>
    (function() {
        // Clear stale state from previous card (Anki reuses the webview)
        window.__defAudioRawHtml = null;
        window.__defAudioNativeContainer = null;
        window.__defAudioEls = [];
        window.__monoUnlocked = false;
        window.__autoPlayDefAudio = null;
        window.__playLockedDefAudio = null;

        var container = document.getElementById('def-audio-container');
        if (!container) return;

        // Tagged definition audio: defer to _renderBack()
        if (container.innerHTML.indexOf('def-type="') !== -1) {
            if (container.textContent.indexOf('[audio:') !== -1) {
                window.__defAudioRawHtml = container.innerHTML;
                container.remove();
            } else {
                window.__defAudioNativeContainer = container;
            }
            return;
        }

        // Check for [audio:] custom tags vs [sound:] native tags
        if (container.textContent.indexOf('[audio:') !== -1) {
            // [audio:] — JS playback path
            var result = window.__extractAudio(container);
            var filenames = result.filenames;
            container.remove();
            if (!filenames.length) return;

            var SVG = window.__audioSVG;
            var audioRow = document.querySelector('.audio-row');
            var audios = [];
            var btns = [];

            var item = document.createElement('div');
            item.className = 'audio-item bi';
            item.setAttribute('data-audio', 'def');

            for (var i = 0; i < filenames.length; i++) {
                var audio = document.createElement('audio');
                audio.preload = 'auto';
                audio.src = filenames[i];
                document.body.appendChild(audio);
                audios.push(audio);
                window.__defAudioEls.push(audio);

                var btn = document.createElement('a');
                btn.className = 'replay-button';
                btn.href = '#';
                btn.innerHTML = SVG;
                item.appendChild(btn);
                btns.push(btn);
            }

            var label = document.createElement('span');
            label.className = 'audio-label';
            label.textContent = 'Definition';
            item.appendChild(label);
            if (audioRow) audioRow.appendChild(item);

            var animateBtn = window.__animateBtn;

            function playSingleFresh(idx) {
                window.__stopAllAudio();
                var a = new Audio(filenames[idx]);
                window.__defAudioEls.push(a);
                a.play();
                animateBtn(btns[idx]);
            }

            function playAll() {
                window.__stopAllAudio();
                var idx = 0;
                function playNext() {
                    if (idx >= audios.length) return;
                    var cur = idx++;
                    audios[cur].currentTime = 0;
                    audios[cur].onended = playNext;
                    audios[cur].play();
                    animateBtn(btns[cur]);
                }
                playNext();
            }

            for (var j = 0; j < btns.length; j++) {
                (function(idx) {
                    btns[idx].addEventListener('click', function(ev) { ev.preventDefault(); playSingleFresh(idx); });
                })(j);
            }

            window.__playLockedDefAudio = playAll;
            window.__autoPlayDefAudio = playAll;

            var toggle = document.getElementById('jp-toggle');
            if (toggle) {
                toggle.addEventListener('change', function() {
                    if (toggle.checked && !window.__monoUnlocked) playAll();
                });
            }
        } else {
            // [sound:] — adopt native elements
            var nativeEls = Array.from(container.querySelectorAll('.replay-button, audio'));
            var buttons = window.__adoptNativeAudio(nativeEls);
            container.remove();
            if (!buttons.length) return;

            var audioRow = document.querySelector('.audio-row');
            var item = document.createElement('div');
            item.className = 'audio-item bi';
            item.setAttribute('data-audio', 'def');
            for (var i = 0; i < buttons.length; i++) {
                item.appendChild(buttons[i]);
            }
            var label = document.createElement('span');
            label.className = 'audio-label';
            label.textContent = 'Definition';
            item.appendChild(label);
            if (audioRow) audioRow.appendChild(item);

            window.__playLockedDefAudio = function() {
                buttons[0].click();
                window.__animateBtn(buttons[0]);
            };

            var toggle = document.getElementById('jp-toggle');
            if (toggle) {
                toggle.addEventListener('change', function() {
                    if (toggle.checked && !window.__monoUnlocked) buttons[0].click();
                });
            }
        }
    })();
    </script>
    <div class="answer">
        <h1 class="target-word" style="--d:0" id="target-word"></h1>
        <p class="sentence" style="--d:50" id="sentence"></p>
        {{#Image}}
        <div class="image-wrap" style="--d:95">{{Image}}</div>
        {{/Image}}
        <p class="def" style="--d:130" id="def-bilingual"></p>
        <div class="jp-def-section" style="--d:170" id="jp-def-section">
            <input type="checkbox" id="jp-toggle" class="jp-def-input">
            <label for="jp-toggle" class="jp-def-toggle" onclick="">Monolingual</label>
            <div class="jp-def-wrap">
                <p class="jp-def" id="def-monolingual"></p>
            </div>
        </div>
        <div class="audio-row-bottom" id="audio-row-bottom"></div>
    </div>
</div>
</div>

<div id="raw-word" style="display:none">{{furigana:Word}}</div>
<div id="raw-sentence" style="display:none">{{Sentence}}</div>
<div id="raw-definition" style="display:none">{{Definition}}</div>

<script>
(function() {
// ── Tone coloring ──
function detectTone(rtText, baseChar) {
  var t = (rtText || '').trim();
  if (t.includes('˙')) return 'tone5';
  if (t.includes('ˊ')) return 'tone2';
  if (t.includes('ˇ')) return 'tone3';
  if (t.includes('ˋ')) return 'tone4';

  var base = (baseChar || '').trim();
  if (base === '兒' || base === 'ㄦ' || /ㄦ/.test(t)) return 'tone5';

  return 'tone1';
}

function applyToneColoring(container) {
  var rubies = Array.prototype.slice.call(container.getElementsByTagName('ruby'));
  rubies.forEach(function(ruby) {
    var node = ruby.firstChild;
    while (node) {
      if (node.nodeType === 3 && /\S/.test(node.nodeValue)) {
        var charNode = node;
        var rt = charNode.nextSibling;
        while (rt && !(rt.nodeType === 1 && rt.tagName.toLowerCase() === 'rt')) rt = rt.nextSibling;
        if (rt) {
          var baseChar = charNode.nodeValue;
          var toneClass = detectTone(rt.textContent || '', baseChar);
          var wrap = document.createElement('span');
          wrap.className = toneClass;
          ruby.insertBefore(wrap, charNode);
          wrap.appendChild(charNode);
          wrap.appendChild(rt);
          node = wrap.nextSibling;
          continue;
        }
      }

      if (node.nodeType === 1 && node.tagName.toLowerCase() === 'rb') {
        var rb = node;
        var next = rb.nextElementSibling;
        if (next && next.tagName.toLowerCase() === 'rt') {
          var toneClass = detectTone(next.textContent || '', rb.textContent || '');
          var wrap = document.createElement('span');
          wrap.className = toneClass;
          ruby.insertBefore(wrap, rb);
          wrap.appendChild(rb);
          wrap.appendChild(next);
          node = wrap.nextSibling;
          continue;
        }
      }

      node = node.nextSibling;
    }
  });
}

// ── parseDefinitions ──
function parseDefinitions(html) {
  const defs = {};
  var CMT = '<' + '!--';
  var END = '--' + '>';
  const re = new RegExp(CMT + '\\s*def-type="(\\w+)".*?' + END + '([\\s\\S]*?)' + CMT + '\\s*def-end\\s*' + END, 'g');
  let m;
  while ((m = re.exec(html)) !== null) {
    defs[m[1]] = m[2].trim();
  }
  return defs;
}

// ── Render (deferred for Anki front→back transitions) ──
function _renderBack() {
  var wordRaw = document.getElementById('raw-word');
  if (!wordRaw) return setTimeout(_renderBack, 10);

  wordRaw = wordRaw.innerHTML.trim();
  var sentRaw = document.getElementById('raw-sentence').innerHTML.trim();
  var defHtml = document.getElementById('raw-definition').innerHTML;

  var targetEl = document.getElementById('target-word');
  var sentEl = document.getElementById('sentence');
  var defEl = document.getElementById('def-bilingual');
  var jpDefSection = document.getElementById('jp-def-section');
  var jpDefEl = document.getElementById('def-monolingual');

  // Word → target word with tone coloring
  if (wordRaw) {
    targetEl.innerHTML = wordRaw;
    applyToneColoring(targetEl);
  } else {
    targetEl.style.display = 'none';
  }

  // Sentence
  if (sentRaw) {
    sentEl.innerHTML = sentRaw;
  }

  // Definition → bilingual + monolingual
  var defs = parseDefinitions(defHtml);
  var monoKey = defs.monolingual ? 'monolingual' : (defs.LOCKED_monolingual ? 'LOCKED_monolingual' : null);
  var biKey = defs.bilingual ? 'bilingual' : (defs.bilingual_jp ? 'bilingual_jp' : (defs.LOCKED_bilingual ? 'LOCKED_bilingual' : (defs.LOCKED_bilingual_jp ? 'LOCKED_bilingual_jp' : null)));
  var hasBi = !!biKey;
  var biIsJp = biKey === 'bilingual_jp' || biKey === 'LOCKED_bilingual_jp';
  var hasMono = !!monoKey;

  if (hasBi && !hasMono) {
    defEl.innerHTML = defs[biKey];
    if (biIsJp) { defEl.style.fontFamily = "'Noto Serif JP', 'Hiragino Mincho ProN', 'Yu Mincho', serif"; defEl.style.lineHeight = '1.65'; }
    jpDefSection.style.display = 'none';
  } else if (hasMono && !hasBi) {
    defEl.innerHTML = defs[monoKey];
    defEl.style.fontFamily = "'Noto Serif TC', 'MOE', serif";
    defEl.style.lineHeight = '1.65';
    jpDefSection.style.display = 'none';
    window.__monoUnlocked = true;
  } else if (hasBi && hasMono) {
    if (defs.monolingual) {
      defEl.innerHTML = defs.monolingual;
      defEl.style.fontFamily = "'Noto Serif TC', 'MOE', serif";
      defEl.style.lineHeight = '1.65';
      jpDefEl.innerHTML = defs[biKey];
      jpDefEl.className = 'def';
      if (biIsJp) { jpDefEl.style.fontFamily = "'Noto Serif JP', 'Hiragino Mincho ProN', 'Yu Mincho', serif"; jpDefEl.style.lineHeight = '1.65'; }
      var toggleLabel = document.querySelector('.jp-def-toggle');
      if (toggleLabel) toggleLabel.textContent = 'Bilingual';
      window.__monoUnlocked = true;
    } else {
      defEl.innerHTML = defs[biKey];
      if (biIsJp) { defEl.style.fontFamily = "'Noto Serif JP', 'Hiragino Mincho ProN', 'Yu Mincho', serif"; defEl.style.lineHeight = '1.65'; }
      jpDefEl.innerHTML = defs.LOCKED_monolingual;
    }
  } else {
    defEl.style.display = 'none';
    jpDefSection.style.display = 'none';
  }

  // ── Tagged definition audio: native [sound:] elements ──
  if (window.__defAudioNativeContainer) {
    var nativeContainer = window.__defAudioNativeContainer;
    window.__defAudioNativeContainer = null;

    var nodes = Array.from(nativeContainer.childNodes);
    var nativeGroups = {};
    var curType = null;
    for (var ni = 0; ni < nodes.length; ni++) {
      var node = nodes[ni];
      if (node.nodeType === 8) {
        var typeMatch = node.textContent.match(/def-type="(\w+)"/);
        if (typeMatch) {
          curType = typeMatch[1];
          nativeGroups[curType] = [];
        } else if (node.textContent.indexOf('def-end') !== -1) {
          curType = null;
        }
      } else if (curType && node.nodeType === 1) {
        nativeGroups[curType].push(node);
      }
    }

    var nativeBiKey = nativeGroups.bilingual ? 'bilingual' : (nativeGroups.bilingual_jp ? 'bilingual_jp' : (nativeGroups.LOCKED_bilingual ? 'LOCKED_bilingual' : (nativeGroups.LOCKED_bilingual_jp ? 'LOCKED_bilingual_jp' : null)));
    var biBtns = nativeBiKey ? window.__adoptNativeAudio(nativeGroups[nativeBiKey]) : [];
    var nativeMonoKey = nativeGroups.monolingual ? 'monolingual' : (nativeGroups.LOCKED_monolingual ? 'LOCKED_monolingual' : null);
    var monoBtns = nativeMonoKey ? window.__adoptNativeAudio(nativeGroups[nativeMonoKey]) : [];
    var hasBiBtns = biBtns.length > 0;
    var hasMonoBtns = monoBtns.length > 0;

    if (hasBiBtns || hasMonoBtns) {
      var audioRow = document.querySelector('.audio-row');

      if (hasBiBtns && hasMonoBtns) {
        var makeNativeDefItem = function(label, btns) {
          var item = document.createElement('div');
          item.className = 'audio-item bi';
          item.setAttribute('data-audio', 'def');
          for (var bk = 0; bk < btns.length; bk++) {
            item.appendChild(btns[bk]);
          }
          var lbl = document.createElement('span');
          lbl.className = 'audio-label';
          lbl.textContent = label;
          item.appendChild(lbl);
          if (audioRow) audioRow.appendChild(item);
        };

        if (window.__monoUnlocked) {
          makeNativeDefItem('Mono-Def', monoBtns);
          makeNativeDefItem('Bi-Def', biBtns);
        } else {
          makeNativeDefItem('Bi-Def', biBtns);
          makeNativeDefItem('Mono-Def', monoBtns);
        }

        var primaryBtns = window.__monoUnlocked ? monoBtns : biBtns;
        var secondaryBtns = window.__monoUnlocked ? biBtns : monoBtns;

        window.__playLockedDefAudio = function() {
          primaryBtns[0].click();
          window.__animateBtn(primaryBtns[0]);
        };

        var defToggle = document.getElementById('jp-toggle');
        if (defToggle) {
          defToggle.addEventListener('change', function() {
            if (defToggle.checked) secondaryBtns[0].click();
          });
        }
      } else {
        var singleBtns = hasBiBtns ? biBtns : monoBtns;
        var singleType = hasBiBtns ? 'bilingual' : 'monolingual';

        var singleItem = document.createElement('div');
        singleItem.className = 'audio-item bi';
        singleItem.setAttribute('data-audio', 'def');
        for (var si = 0; si < singleBtns.length; si++) {
          singleItem.appendChild(singleBtns[si]);
        }
        var singleLabel = document.createElement('span');
        singleLabel.className = 'audio-label';
        singleLabel.textContent = 'Definition';
        singleItem.appendChild(singleLabel);
        if (audioRow) audioRow.appendChild(singleItem);

        window.__playLockedDefAudio = function() {
          singleBtns[0].click();
          window.__animateBtn(singleBtns[0]);
        };

        var singleShown = (singleType === 'bilingual' && !window.__monoUnlocked) ||
                           (singleType === 'monolingual' && !!window.__monoUnlocked);
        if (!singleShown) {
          var defToggle = document.getElementById('jp-toggle');
          if (defToggle) {
            defToggle.addEventListener('change', function() {
              if (defToggle.checked) singleBtns[0].click();
            });
          }
        }
      }
    }

    nativeContainer.remove();
  }

  // ── Tagged definition audio: [audio:] JS playback ──
  if (window.__defAudioRawHtml) {
    var audioDefs = parseDefinitions(window.__defAudioRawHtml);

    var extractAudioFilenames = function(blockHtml) {
      var tmp = document.createElement('div');
      tmp.innerHTML = blockHtml;
      return window.__extractAudio(tmp).filenames;
    };

    var audioBiKey = audioDefs.bilingual ? 'bilingual' : (audioDefs.bilingual_jp ? 'bilingual_jp' : (audioDefs.LOCKED_bilingual ? 'LOCKED_bilingual' : (audioDefs.LOCKED_bilingual_jp ? 'LOCKED_bilingual_jp' : null)));
    var biFilenames = audioBiKey ? extractAudioFilenames(audioDefs[audioBiKey]) : [];
    var audioMonoKey = audioDefs.monolingual ? 'monolingual' : (audioDefs.LOCKED_monolingual ? 'LOCKED_monolingual' : null);
    var monoFilenames = audioMonoKey ? extractAudioFilenames(audioDefs[audioMonoKey]) : [];
    var hasBiAudio = biFilenames.length > 0;
    var hasMonoAudio = monoFilenames.length > 0;

    if (hasBiAudio || hasMonoAudio) {
      var primaryFilenames, secondaryFilenames, primaryType;

      if (hasBiAudio && hasMonoAudio) {
        if (window.__monoUnlocked) {
          primaryFilenames = monoFilenames;
          secondaryFilenames = biFilenames;
          primaryType = 'monolingual';
        } else {
          primaryFilenames = biFilenames;
          secondaryFilenames = monoFilenames;
          primaryType = 'bilingual';
        }
      } else {
        primaryFilenames = hasBiAudio ? biFilenames : monoFilenames;
        secondaryFilenames = null;
        primaryType = hasBiAudio ? 'bilingual' : 'monolingual';
      }

      var primaryAudios = [];
      for (var pi = 0; pi < primaryFilenames.length; pi++) {
        var pa = document.createElement('audio');
        pa.preload = 'auto';
        pa.src = primaryFilenames[pi];
        document.body.appendChild(pa);
        primaryAudios.push(pa);
        window.__defAudioEls.push(pa);
      }

      var secondaryAudios = [];
      if (secondaryFilenames) {
        for (var sk = 0; sk < secondaryFilenames.length; sk++) {
          var sa = document.createElement('audio');
          sa.preload = 'auto';
          sa.src = secondaryFilenames[sk];
          document.body.appendChild(sa);
          secondaryAudios.push(sa);
          window.__defAudioEls.push(sa);
        }
      }

      var SVG_DEF = window.__audioSVG;
      var animateBtnDef = window.__animateBtn;

      var playGroup = function(audioEls) {
        window.__stopAllAudio();
        var idx = 0;
        var playNext = function() {
          if (idx >= audioEls.length) return;
          var cur = idx++;
          audioEls[cur].currentTime = 0;
          audioEls[cur].onended = playNext;
          audioEls[cur].play();
        };
        playNext();
      };

      var audioRow = document.querySelector('.audio-row');

      if (hasBiAudio && hasMonoAudio) {
        var makeDefItem = function(label, filenames, audioEls) {
          var item = document.createElement('div');
          item.className = 'audio-item bi';
          item.setAttribute('data-audio', 'def');
          var btn = document.createElement('a');
          btn.className = 'replay-button';
          btn.href = '#';
          btn.innerHTML = SVG_DEF;
          item.appendChild(btn);
          var lbl = document.createElement('span');
          lbl.className = 'audio-label';
          lbl.textContent = label;
          item.appendChild(lbl);
          if (audioRow) audioRow.appendChild(item);
          var playFn = function() {
            playGroup(audioEls);
            animateBtnDef(btn);
          };
          btn.addEventListener('click', function(ev) {
            ev.preventDefault();
            window.__stopAllAudio();
            var a = new Audio(filenames[0]);
            window.__defAudioEls.push(a);
            a.play();
            animateBtnDef(btn);
          });
          return playFn;
        };

        var playBi, playMono;
        if (window.__monoUnlocked) {
          playMono = makeDefItem('Mono-Def', monoFilenames, primaryAudios);
          playBi = makeDefItem('Bi-Def', biFilenames, secondaryAudios);
        } else {
          playBi = makeDefItem('Bi-Def', biFilenames, primaryAudios);
          playMono = makeDefItem('Mono-Def', monoFilenames, secondaryAudios);
        }

        var playPrimary = window.__monoUnlocked ? playMono : playBi;
        var playSecondary = window.__monoUnlocked ? playBi : playMono;

        window.__playLockedDefAudio = playPrimary;

        var primaryShown = (primaryType === 'bilingual' && !window.__monoUnlocked) ||
                           (primaryType === 'monolingual' && !!window.__monoUnlocked);
        if (primaryShown) {
          window.__autoPlayDefAudio = playPrimary;
        }

        var defToggle = document.getElementById('jp-toggle');
        if (defToggle) {
          defToggle.addEventListener('change', function() {
            if (defToggle.checked) playSecondary();
          });
        }
      } else {
        var defItem = document.createElement('div');
        defItem.className = 'audio-item bi';
        defItem.setAttribute('data-audio', 'def');
        var defBtn = document.createElement('a');
        defBtn.className = 'replay-button';
        defBtn.href = '#';
        defBtn.innerHTML = SVG_DEF;
        defItem.appendChild(defBtn);
        var defLabel = document.createElement('span');
        defLabel.className = 'audio-label';
        defLabel.textContent = 'Definition';
        defItem.appendChild(defLabel);
        if (audioRow) audioRow.appendChild(defItem);

        var playPrimary = function() {
          playGroup(primaryAudios);
          animateBtnDef(defBtn);
        };

        defBtn.addEventListener('click', function(ev) {
          ev.preventDefault();
          window.__stopAllAudio();
          var a = new Audio(primaryFilenames[0]);
          window.__defAudioEls.push(a);
          a.play();
          animateBtnDef(defBtn);
        });
        window.__playLockedDefAudio = playPrimary;

        var primaryShown = (primaryType === 'bilingual' && !window.__monoUnlocked) ||
                           (primaryType === 'monolingual' && !!window.__monoUnlocked);
        if (primaryShown) {
          window.__autoPlayDefAudio = playPrimary;
        } else {
          var defToggle = document.getElementById('jp-toggle');
          if (defToggle) {
            defToggle.addEventListener('change', function() {
              if (defToggle.checked) playPrimary();
            });
          }
        }
      }
    }
  }

  // ── Mirror audio buttons to bottom row (mobile) ──
  var bottomRow = document.getElementById('audio-row-bottom');
  if (bottomRow) {
    var SVG_BOTTOM = window.__audioSVG;
    var animateBtnBottom = window.__animateBtn;
    var topItems = document.querySelectorAll('.audio-row .audio-item');
    for (var bi = 0; bi < topItems.length; bi++) {
      (function(origItem) {
        var clone = document.createElement('div');
        clone.className = 'audio-item';
        var origBtns = origItem.querySelectorAll('.replay-button');
        for (var bj = 0; bj < origBtns.length; bj++) {
          (function(origBtn) {
            var btn = document.createElement('a');
            btn.className = 'replay-button';
            btn.href = '#';
            btn.innerHTML = SVG_BOTTOM;
            clone.appendChild(btn);
            btn.addEventListener('click', function(ev) {
              ev.preventDefault();
              origBtn.click();
              animateBtnBottom(btn);
            });
          })(origBtns[bj]);
        }
        var origLabel = origItem.querySelector('.audio-label');
        if (origLabel) {
          var lbl = document.createElement('span');
          lbl.className = 'audio-label';
          lbl.textContent = origLabel.textContent;
          clone.appendChild(lbl);
        }
        bottomRow.appendChild(clone);
      })(topItems[bi]);
    }
  }

  // ── Trigger reveal animations after content is ready ──
  requestAnimationFrame(function() {
    var els = document.querySelectorAll('.answer > [style*="--d"]');
    for (var i = 0; i < els.length; i++) els[i].classList.add('ri');
  });

  // ── Auto-play definition audio (deferred to avoid AnkiDroid [sound:] conflict) ──
  if (window.__autoPlayDefAudio) {
    setTimeout(window.__autoPlayDefAudio, 0);
  }
}
_renderBack();
})();
</script>

<script>
(function() {
  var HANDLER_KEY = '__audioHandler';
  var animateBtn = window.__animateBtn;
  function play(item) {
    if (!item) return;
    window.__stopAllAudio();
    var link = item.querySelector('.soundLink');
    if (link) {
      link.click();
      var btn = item.querySelector('.replay-button');
      if (btn) animateBtn(btn);
      return;
    }
    var audio = item.querySelector('audio');
    if (audio) { audio.currentTime = 0; audio.play(); }
  }
  function playAll() {
    var items = document.querySelectorAll('.audio-row .audio-item');
    var queue = [];
    items.forEach(function(item) {
      var audio = item._jsAudio || item.querySelector('audio');
      var btn = item.querySelector('.replay-button');
      if (audio) queue.push({ audio: audio, btn: btn });
    });
    if (!queue.length) return false;
    window.__stopAllAudio();
    var k = 0;
    function next() {
      if (k >= queue.length) {
        if (window.__playLockedDefAudio) window.__playLockedDefAudio();
        return;
      }
      var entry = queue[k++];
      entry.audio.currentTime = 0;
      entry.audio.play();
      if (entry.btn) animateBtn(entry.btn);
      entry.audio.onended = next;
    }
    next();
    return true;
  }
  function handler(ev) {
    var el = ev.target;
    if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable)) return;
    var wordItem = document.querySelector('.audio-row .audio-item[data-audio="word"]');
    var sentItem = document.querySelector('.audio-row .audio-item[data-audio="sentence"]');
    var defItem = document.querySelector('.audio-row .audio-item[data-audio="def"]');
    switch (ev.key.toLowerCase()) {
      case 'n': ev.preventDefault(); ev.stopPropagation(); play(wordItem); break;
      case 'h': ev.preventDefault(); ev.stopPropagation(); play(sentItem); break;
      case ',':
        ev.preventDefault(); ev.stopPropagation();
        if (window.__playLockedDefAudio) window.__playLockedDefAudio();
        else play(defItem);
        break;
      case 'z': if (playAll()) { ev.preventDefault(); ev.stopPropagation(); } break;
      case '?': ev.preventDefault(); ev.stopPropagation(); if (window.__stopAllAudio) window.__stopAllAudio(); break;
    }
  }
  if (window[HANDLER_KEY]) {
    window.removeEventListener('keydown', window[HANDLER_KEY], true);
  }
  window[HANDLER_KEY] = handler;
  window.addEventListener('keydown', handler, { capture: true });
})();
</script>

<script>
(function() {
  var HANDLER_KEY = '__jpDefHandler';
  function animateToggle(label) {
    label.style.color = 'var(--text-1)';
    label.style.borderColor = 'rgba(255, 255, 255, 0.10)';
    label.style.background = 'rgba(255, 255, 255, 0.04)';
    setTimeout(function() {
      label.style.color = '';
      label.style.borderColor = '';
      label.style.background = '';
    }, 350);
  }
  function handler(ev) {
    if (ev.code === 'KeyG' || ev.key === '.') {
      var cb = document.getElementById('jp-toggle');
      if (cb) {
        ev.preventDefault();
        ev.stopPropagation();
        cb.checked = !cb.checked;
        cb.dispatchEvent(new Event('change'));
        var label = document.querySelector('.jp-def-toggle');
        if (label) animateToggle(label);
      }
    }
  }
  if (window[HANDLER_KEY]) {
    window.removeEventListener('keydown', window[HANDLER_KEY], true);
  }
  window[HANDLER_KEY] = handler;
  window.addEventListener('keydown', handler, { capture: true });

  var jpToggle = document.getElementById('jp-toggle');
  if (jpToggle) {
    jpToggle.addEventListener('change', function() {
      if (!jpToggle.checked) return;
    });
  }
})();
</script>
