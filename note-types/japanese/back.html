<div class="card-inner">
<div class="back">
    {{FrontSide}}

    <div class="audio-row">
        {{#Word Audio}}
        <div class="audio-item bi" data-audio="word" style="--d:0">
            {{Word Audio}}
            <span class="audio-label">Word</span>
        </div>
        {{/Word Audio}}
        {{#Sentence Audio}}
        <div class="audio-item bi" data-audio="sentence" style="--d:70">
            {{Sentence Audio}}
            <span class="audio-label">Sentence</span>
        </div>
        {{/Sentence Audio}}
    </div>

    <div class="answer">
        <h1 class="target-word" id="target-word" style="--d:0"></h1>
        <div class="pitch-graph" id="pitch-graph" style="--d:50"></div>
        <p class="sentence" id="sentence" style="--d:95"></p>
        {{#Image}}
        <div class="image-wrap" style="--d:135">{{Image}}</div>
        {{/Image}}
        <div class="audio-row-bottom" id="audio-row-bottom" style="--d:150"></div>
        <p class="def" id="definition" style="--d:170"></p>
    </div>
</div>
</div>

<div id="raw-sentence" style="display:none">{{Sentence}}</div>
<div id="raw-definition" style="display:none">{{Definition}}</div>

<script>
// Replace native <audio> players or [audio:] tags with styled replay buttons
(function() {
  var SVG = window.__audioSVG;
  var animateBtn = window.__animateBtn;
  document.querySelectorAll('.audio-row .audio-item').forEach(function(item) {
    // [audio:] custom tags — extract filename, create Audio + button
    var text = item.textContent;
    var audioMatch = text.match(/\[audio:([^\]]+)\]/);
    if (audioMatch) {
      var audio = document.createElement('audio');
      audio.preload = 'auto';
      audio.src = audioMatch[1].replace(/#/g, '%23').replace(/\?/g, '%3F');
      document.body.appendChild(audio);
      item._jsAudio = audio;
      // Remove raw [audio:...] text nodes, keep <span> label
      Array.from(item.childNodes).forEach(function(n) {
        if (n.nodeType === 3) item.removeChild(n);
      });
      var btn = document.createElement('a');
      btn.className = 'replay-button soundLink';
      btn.href = '#';
      btn.innerHTML = SVG;
      item.insertBefore(btn, item.firstChild);
      window.__onTap(btn, function() {
        window.__stopAllAudio(audio);
        audio.currentTime = 0;
        window.__safePlay(audio);
        animateBtn(btn);
        window.__startPlaying(audio, btn);
      });
      return;
    }
    // [sound:] native — existing code unchanged
    if (item.querySelector('.replay-button')) return;
    var nativeAudio = item.querySelector('audio');
    if (!nativeAudio) return;
    nativeAudio.style.display = 'none';
    nativeAudio.removeAttribute('controls');
    var btn = document.createElement('a');
    btn.className = 'replay-button soundLink';
    btn.href = '#';
    btn.innerHTML = SVG;
    item.insertBefore(btn, item.firstChild);
    window.__onTap(btn, function() {
      window.__stopAllAudio(nativeAudio);
      nativeAudio.currentTime = 0;
      window.__safePlay(nativeAudio);
    });
  });
})();
</script>

<script>
(function() {

// ── Render (deferred for Anki front→back transitions) ──
function _renderBack() {
  var wordRaw = document.getElementById('raw-word');
  if (!wordRaw) return setTimeout(_renderBack, 10);

  wordRaw = wordRaw.innerHTML.trim();
  var sentRaw = document.getElementById('raw-sentence').textContent.trim();
  var defHtml = document.getElementById('raw-definition').innerHTML;

  var targetEl = document.getElementById('target-word');
  var graphEl = document.getElementById('pitch-graph');
  var sentEl = document.getElementById('sentence');
  var defEl = document.getElementById('definition');

  // Word → target word + pitch graph
  if (wordRaw) {
    var wordSeqs = makeSequences(wordRaw);

    if (wordSeqs.length > 0) {
      targetEl.innerHTML = makeColoredSentence(wordSeqs[0]);

      var svgs = [];
      for (var s = 0; s < wordSeqs.length; s++) {
        var svg = makeGraph(wordSeqs[s]);
        if (svg) svgs.push(svg);
      }
      if (svgs.length > 0) {
        graphEl.innerHTML = svgs.join('');
      } else {
        graphEl.style.display = 'none';
      }
    } else {
      graphEl.style.display = 'none';
    }
  } else {
    graphEl.style.display = 'none';
  }

  // Sentence → colored sentence
  if (sentRaw) {
    var sentSeqs = makeSequences(sentRaw);
    if (sentSeqs.length > 0) {
      var hasAccent = sentSeqs[0].some(function(s) {
        return s.role !== 'particle' && s.role !== 'empty' && !s.isParticle;
      });
      if (!hasAccent) sentEl.classList.add('no-accent');
      sentEl.innerHTML = makeColoredSentence(sentSeqs[0]);
    }
  }

  // Definition — Japanese only
  if (defHtml && defHtml.trim()) {
    defEl.innerHTML = defHtml;
  } else {
    defEl.style.display = 'none';
  }

  // ── Mirror audio buttons to bottom row (mobile) ──
  var bottomRow = document.getElementById('audio-row-bottom');
  if (bottomRow) {
    var SVG_BOTTOM = window.__audioSVG;
    var animateBtnBottom = window.__animateBtn;
    var topItems = document.querySelectorAll('.audio-row .audio-item');
    var items = [];
    for (var ti = 0; ti < topItems.length; ti++) items.push(topItems[ti]);
    items.reverse();
    for (var bi = 0; bi < items.length; bi++) {
      (function(origItem) {
        var clone = document.createElement('div');
        clone.className = 'audio-item';
        var origBtns = origItem.querySelectorAll('.replay-button');
        for (var bj = 0; bj < origBtns.length; bj++) {
          (function(origBtn) {
            var btn = document.createElement('a');
            btn.className = 'replay-button';
            btn.href = '#';
            btn.innerHTML = SVG_BOTTOM;
            clone.appendChild(btn);
            window.__onTap(btn, function() {
              if (origBtn._tapHandler) origBtn._tapHandler();
              else origBtn.click();
              animateBtnBottom(btn);
            });
            var obs = new MutationObserver(function() {
              btn.classList.toggle('playing', origBtn.classList.contains('playing'));
            });
            obs.observe(origBtn, { attributes: true, attributeFilter: ['class'] });
            window.__observers.push(obs);
          })(origBtns[bj]);
        }
        var origLabel = origItem.querySelector('.audio-label');
        if (origLabel) {
          var lbl = document.createElement('span');
          lbl.className = 'audio-label';
          lbl.textContent = origLabel.textContent;
          clone.appendChild(lbl);
        }
        bottomRow.appendChild(clone);
      })(items[bi]);
    }
  }

  // ── Trigger reveal animations after content is ready ──
  requestAnimationFrame(function() {
    var els = document.querySelectorAll('.answer > [style*="--d"]');
    for (var i = 0; i < els.length; i++) els[i].classList.add('ri');
  });
}
_renderBack();
})();
</script>

<script>
(function() {
  var HANDLER_KEY = '__audioHandler';
  var animateBtn = window.__animateBtn;
  function play(item) {
    if (!item) return;
    window.__stopAllAudio();
    var link = item.querySelector('.soundLink');
    if (link) {
      link.click();
      var btn = item.querySelector('.replay-button');
      if (btn) animateBtn(btn);
      return;
    }
    var audio = item.querySelector('audio');
    if (audio) { audio.currentTime = 0; window.__safePlay(audio); }
  }
  function playAll() {
    var items = document.querySelectorAll('.audio-row .audio-item');
    var queue = [];
    items.forEach(function(item) {
      var audio = item._jsAudio || item.querySelector('audio');
      var btn = item.querySelector('.replay-button');
      if (audio) queue.push({ audio: audio, btn: btn, js: !!item._jsAudio });
    });
    if (!queue.length) return false;
    window.__stopAllAudio();
    var k = 0;
    function next() {
      if (k >= queue.length) return;
      var entry = queue[k++];
      entry.audio.currentTime = 0;
      window.__safePlay(entry.audio);
      if (entry.btn) animateBtn(entry.btn);
      if (entry.js) window.__startPlaying(entry.audio, entry.btn);
      entry.audio.onended = next;
    }
    next();
    return true;
  }
  function handler(ev) {
    var el = ev.target;
    if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable)) return;
    var wordItem = document.querySelector('.audio-row .audio-item[data-audio="word"]');
    var sentItem = document.querySelector('.audio-row .audio-item[data-audio="sentence"]');
    switch (ev.key.toLowerCase()) {
      case 'n': ev.preventDefault(); ev.stopPropagation(); play(wordItem); break;
      case 'h': ev.preventDefault(); ev.stopPropagation(); play(sentItem); break;
      case 'z': if (playAll()) { ev.preventDefault(); ev.stopPropagation(); } break;
      case '?': ev.preventDefault(); ev.stopPropagation(); if (window.__stopAllAudio) window.__stopAllAudio(); break;
    }
  }
  if (window[HANDLER_KEY]) {
    window.removeEventListener('keydown', window[HANDLER_KEY], true);
  }
  window[HANDLER_KEY] = handler;
  window.addEventListener('keydown', handler, { capture: true });

  // Stop all audio when a native [sound:] replay button is tapped on mobile
  var audioRow = document.querySelector('.audio-row');
  if (audioRow) {
    audioRow.addEventListener('click', function(ev) {
      var btn = ev.target.closest('.replay-button');
      if (btn && !btn._hasHandler) window.__stopAllAudio();
    }, true);
  }
})();
</script>
