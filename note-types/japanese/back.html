<div class="card-inner">
<div class="back">
    {{FrontSide}}

    {{#Audio}}
    <div id="audio-container" style="display:none">{{Audio}}</div>
    {{/Audio}}
    <div class="audio-row" id="audio-row"></div>

    <div class="answer">
        <div class="pitch-graph" id="pitch-graph" style="--d:50"></div>
        <p class="sentence" id="sentence" style="--d:95"></p>
        {{#Image}}
        <div class="image-wrap" style="--d:135">{{Image}}</div>
        {{/Image}}
        <div class="audio-row-bottom" id="audio-row-bottom" style="--d:150"></div>
        <p class="def" id="definition" style="--d:170"></p>
    </div>
</div>
</div>

<div id="raw-sentence" style="display:none">{{Prompt}}</div>
<div id="raw-definition" style="display:none">{{Explanation}}</div>

<script>
// Build audio buttons from the combined Audio field
(function() {
  var container = document.getElementById('audio-container');
  if (!container) return;
  var row = document.getElementById('audio-row');
  var SVG = window.__audioSVG;
  var animateBtn = window.__animateBtn;
  var files = [];

  // Extract [audio:filename] custom tags
  var text = container.textContent;
  var re = /\[audio:([^\]]+)\]/g;
  var m;
  while ((m = re.exec(text)) !== null) files.push({ src: m[1], type: 'custom' });

  // Extract native <audio> elements (from [sound:] tags)
  var nativeAudios = container.querySelectorAll('audio');
  for (var i = 0; i < nativeAudios.length; i++) {
    var src = nativeAudios[i].querySelector('source');
    src = src ? src.src : nativeAudios[i].src;
    if (src) files.push({ src: src, type: 'native' });
  }

  for (var j = 0; j < files.length; j++) {
    (function(file, idx) {
      var item = document.createElement('div');
      item.className = 'audio-item bi';
      item.style.setProperty('--d', idx * 70);

      var audio = document.createElement('audio');
      audio.preload = 'auto';
      audio.src = file.type === 'custom'
        ? file.src.replace(/#/g, '%23').replace(/\?/g, '%3F')
        : file.src;
      document.body.appendChild(audio);
      item._jsAudio = audio;

      var btn = document.createElement('a');
      btn.className = 'replay-button soundLink';
      btn.href = '#';
      btn.innerHTML = SVG;
      item.appendChild(btn);
      window.__onTap(btn, function() {
        window.__stopAllAudio(audio);
        if (window.matchMedia('(hover: none)').matches) {
          var fa = window.__freshPlay(audio.src, btn);
          animateBtn(btn);
          window.__startPlaying(fa, btn);
        } else {
          audio.currentTime = 0;
          window.__safePlay(audio);
          animateBtn(btn);
          window.__startPlaying(audio, btn);
        }
      });

      row.appendChild(item);
    })(files[j], j);
  }

  container.parentNode.removeChild(container);
})();
</script>

<script>
(function() {

// ── Render (deferred for Anki front→back transitions) ──
function _renderBack() {
  var wordRaw = document.getElementById('raw-word');
  if (!wordRaw) return setTimeout(_renderBack, 10);

  wordRaw = wordRaw.innerHTML.trim();
  var sentRaw = document.getElementById('raw-sentence').textContent.trim();
  var defHtml = document.getElementById('raw-definition').innerHTML;

  var graphEl = document.getElementById('pitch-graph');
  var sentEl = document.getElementById('sentence');
  var defEl = document.getElementById('definition');

  // Word → reveal colors/furigana in place + pitch graph
  var frontDiv = document.querySelector('.front');
  var frontWord = document.getElementById('front-word');
  if (wordRaw) {
    var wordSeqs = makeSequences(wordRaw);

    if (wordSeqs.length > 0) {
      if (frontDiv) { frontDiv.style.display = 'contents'; frontDiv.classList.remove('front'); }
      if (frontWord) {
        frontWord.classList.add('reveal');
        if (wordRaw.indexOf(':') === -1) frontWord.classList.add('no-accent');
      }
    }

    if (wordSeqs.length > 0 && wordRaw.indexOf(':') !== -1) {
      var svgs = [];
      for (var s = 0; s < wordSeqs.length; s++) {
        var svg = makeGraph(wordSeqs[s]);
        if (svg) svgs.push(svg);
      }
      if (svgs.length > 0) {
        graphEl.innerHTML = svgs.join('');
      } else {
        graphEl.style.display = 'none';
      }
    } else {
      graphEl.style.display = 'none';
    }
  } else {
    graphEl.style.display = 'none';
  }

  // Sentence → colored sentence
  if (sentRaw) {
    var sentSeqs = makeSequences(sentRaw);
    if (sentSeqs.length > 0) {
      var hasAccent = sentSeqs[0].some(function(s) {
        return s.role !== 'particle' && s.role !== 'empty' && !s.isParticle;
      });
      if (!hasAccent) sentEl.classList.add('no-accent');
      sentEl.innerHTML = makeColoredSentence(sentSeqs[0]);
    }
  }

  // Definition — Japanese only
  if (defHtml && defHtml.trim()) {
    defEl.innerHTML = defHtml;
  } else {
    defEl.style.display = 'none';
  }

  // ── Mirror audio buttons to bottom row (mobile) ──
  var bottomRow = document.getElementById('audio-row-bottom');
  if (bottomRow) {
    var SVG_BOTTOM = window.__audioSVG;
    var animateBtnBottom = window.__animateBtn;
    var topItems = document.querySelectorAll('.audio-row .audio-item');
    for (var bi = 0; bi < topItems.length; bi++) {
      (function(origItem) {
        var clone = document.createElement('div');
        clone.className = 'audio-item';
        var origBtn = origItem.querySelector('.replay-button');
        if (!origBtn) return;
        var btn = document.createElement('a');
        btn.className = 'replay-button';
        btn.href = '#';
        btn.innerHTML = SVG_BOTTOM;
        clone.appendChild(btn);
        window.__onTap(btn, function() {
          if (origBtn._tapHandler) origBtn._tapHandler();
          else origBtn.click();
          animateBtnBottom(btn);
        });
        var obs = new MutationObserver(function() {
          btn.classList.toggle('playing', origBtn.classList.contains('playing'));
        });
        obs.observe(origBtn, { attributes: true, attributeFilter: ['class'] });
        window.__observers.push(obs);
        bottomRow.appendChild(clone);
      })(topItems[bi]);
    }
  }

  // ── Trigger reveal animations after content is ready ──
  requestAnimationFrame(function() {
    var els = document.querySelectorAll('.answer > [style*="--d"]');
    for (var i = 0; i < els.length; i++) els[i].classList.add('ri');
  });
}
_renderBack();
})();
</script>

<script>
(function() {
  var HANDLER_KEY = '__audioHandler';
  var animateBtn = window.__animateBtn;
  function playAll() {
    var items = document.querySelectorAll('.audio-row .audio-item');
    var queue = [];
    for (var i = 0; i < items.length; i++) {
      var audio = items[i]._jsAudio;
      var btn = items[i].querySelector('.replay-button');
      if (audio) queue.push({ audio: audio, btn: btn });
    }
    if (!queue.length) return false;
    window.__stopAllAudio();
    var k = 0;
    function next() {
      if (k >= queue.length) return;
      var entry = queue[k++];
      entry.audio.currentTime = 0;
      window.__safePlay(entry.audio);
      if (entry.btn) animateBtn(entry.btn);
      window.__startPlaying(entry.audio, entry.btn);
      entry.audio.onended = next;
    }
    next();
    return true;
  }
  function handler(ev) {
    var el = ev.target;
    if (el && (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA' || el.isContentEditable)) return;
    switch (ev.key.toLowerCase()) {
      case 'n': ev.preventDefault(); ev.stopPropagation(); playAll(); break;
      case '?': ev.preventDefault(); ev.stopPropagation(); if (window.__stopAllAudio) window.__stopAllAudio(); break;
    }
  }
  if (window[HANDLER_KEY]) {
    window.removeEventListener('keydown', window[HANDLER_KEY], true);
  }
  window[HANDLER_KEY] = handler;
  window.addEventListener('keydown', handler, { capture: true });
})();
</script>
